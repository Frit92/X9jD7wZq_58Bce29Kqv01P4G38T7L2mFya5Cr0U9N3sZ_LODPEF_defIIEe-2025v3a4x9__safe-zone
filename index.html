<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fritflix Feedback</title>
  <style>
    :root {
      --primary: #e50914;
      --primary-hover: #f41a22;
      --secondary: #333;
      --text: #fff;
      --bg: #111;
      --box-bg: #222;
      --border: #444;
      --success: #28a745;
      --error: #dc3545;
      --blue: #1a73e8;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1em;
      text-align: center;
      min-height: 100vh;
      margin: 0;
      gap: 1em;
    }

    h1 {
      font-size: 1.8em;
      margin: 0.5em 0;
      font-weight: 600;
    }

    #status-box {
      background: var(--box-bg);
      padding: 1.2em;
      border-radius: 0.6em;
      width: 95%;
      max-width: 420px;
      text-align: left;
      font-size: 0.98em;
      line-height: 1.6;
      border: 1px solid var(--border);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    progress {
      width: 100%;
      height: 20px;
      margin: 0.5em 0;
      border-radius: 10px;
      overflow: hidden;
    }

    progress::-webkit-progress-bar { background: #333; border-radius: 10px; }
    progress::-webkit-progress-value { background: var(--primary); border-radius: 10px; }
    progress.high::-webkit-progress-value { background: var(--error); }
    progress.blue::-webkit-progress-value { background: var(--blue); }

    .button-container {
      display: flex;
      flex-direction: column;
      gap: 0.7em;
      width: 95%;
      max-width: 420px;
    }

    .btn-row {
      display: flex;
      gap: 0.5em;
      width: 100%;
    }

    button {
      border: none;
      border-radius: 0.5em;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }

    .feedback-btn {
      flex: 1;
      background: var(--primary);
      color: white;
      font-size: 1.1em;
      padding: 1em 0.8em;
      min-height: 56px;
    }

    .feedback-btn:hover { background: var(--primary-hover); }
    .feedback-btn:disabled { background: #999; cursor: not-allowed; }

    .note-btn {
      background: var(--secondary);
      color: white;
      font-size: 1.3em;
      width: 56px;
      min-height: 56px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .note-btn:hover { background: #444; }

    .speedtest-btn {
      background: var(--blue);
      color: white;
      font-weight: 600;
      margin: 1.2em 0;
      padding: 1.1em;
      font-size: 1.15em;
      border-radius: 0.6em;
    }

    .speedtest-btn:hover { background: #0d62c7; }
    .speedtest-btn.loading { background: #666; }
    .speedtest-btn.success { background: var(--success); }
    .speedtest-btn.error { background: var(--error); }

    #modal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #333;
      padding: 1.6em;
      border-radius: 0.6em;
      width: 88%;
      max-width: 420px;
      z-index: 100;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    #modal h3 { margin: 0 0 0.9em; font-size: 1.25em; }
    #modal textarea {
      width: 100%;
      height: 110px;
      background: #444;
      color: white;
      border: 1px solid #666;
      border-radius: 0.4em;
      padding: 0.6em;
      font-size: 0.98em;
      resize: none;
    }

    #modal button {
      margin: 0.5em 0.25em 0;
      padding: 0.8em 1.2em;
      min-height: auto;
      font-size: 0.98em;
    }

    #status {
      margin-top: 1em;
      font-size: 0.98em;
      min-height: 1.6em;
      font-weight: 500;
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      .feedback-btn { font-size: 1em; padding: 0.9em 0.7em; }
      .note-btn { font-size: 1.2em; width: 50px; height: 50px; }
      .speedtest-btn { font-size: 1.05em; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <h1>Feedback zu Fritflix</h1>

  <div id="status-box">Lade Server-Status...</div>

  <!-- Speedtest Button -->
  <button id="speedtest-btn" class="speedtest-btn" onclick="runSpeedtest()">
    Speedtest starten
  </button>

  <!-- Feedback Buttons -->
  <div class="button-container">
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Server offline')" data-orig="Server offline">Server offline</button>
      <button class="note-btn" onclick="openModal('Server offline')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Anmeldung nicht m√∂glich')" data-orig="Anmeldung nicht m√∂glich">Anmeldung nicht m√∂glich</button>
      <button class="note-btn" onclick="openModal('Anmeldung nicht m√∂glich')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Stream startet nicht')" data-orig="Stream startet nicht">Stream startet nicht</button>
      <button class="note-btn" onclick="openModal('Stream startet nicht')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Stream ruckelt')" data-orig="Stream ruckelt">Stream ruckelt</button>
      <button class="note-btn" onclick="openModal('Stream ruckelt')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Stream stoppt an bestimmter Stelle')" data-orig="Stream stoppt an bestimmter Stelle">Stream stoppt an bestimmter Stelle</button>
      <button class="note-btn" onclick="openModal('Stream stoppt an bestimmter Stelle')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Kein Ton vorhanden')" data-orig="Kein Ton vorhanden">Kein Ton vorhanden</button>
      <button class="note-btn" onclick="openModal('Kein Ton vorhanden')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Ton und Bild nicht synchron')" data-orig="Ton und Bild nicht synchron">Ton und Bild nicht synchron</button>
      <button class="note-btn" onclick="openModal('Ton und Bild nicht synchron')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Originaltonspur fehlt')" data-orig="Originaltonspur fehlt">Originaltonspur fehlt</button>
      <button class="note-btn" onclick="openModal('Originaltonspur fehlt')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Untertitel fehlen')" data-orig="Untertitel fehlen">Untertitel fehlen</button>
      <button class="note-btn" onclick="openModal('Untertitel fehlen')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Untertitel nicht synchron')" data-orig="Untertitel nicht synchron">Untertitel nicht synchron</button>
      <button class="note-btn" onclick="openModal('Untertitel nicht synchron')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Bildqualit√§t schlecht (kein HD)')" data-orig="Bildqualit√§t schlecht (kein HD)">Bildqualit√§t schlecht (kein HD)</button>
      <button class="note-btn" onclick="openModal('Bildqualit√§t schlecht (kein HD)')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'Falscher Film/Serie wird abgespielt')" data-orig="Falscher Film/Serie wird abgespielt">Falscher Film/Serie wird abgespielt</button>
      <button class="note-btn" onclick="openModal('Falscher Film/Serie wird abgespielt')">üìù</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" onclick="sendDirect(this, 'App st√ºrzt ab')" data-orig="App st√ºrzt ab">App st√ºrzt ab</button>
      <button class="note-btn" onclick="openModal('App st√ºrzt ab')">üìù</button>
    </div>
  </div>

  <button class="feedback-btn" style="margin-top: 0.6em; padding: 1em;" onclick="openModal('Anderes Problem', true)">Anderes Problem</button>

  <div id="status"></div>

  <!-- Modal -->
  <div id="modal">
    <h3 id="modal-title"></h3>
    <textarea id="extra-text" placeholder="Zus√§tzliche Beschreibung..."></textarea>
    <br>
    <button class="feedback-btn" onclick="sendWithText()">Senden mit Text</button>
    <button onclick="closeModal()">Abbrechen</button>
    <button id="no-text-btn" class="feedback-btn" onclick="sendWithoutText()">Ohne Text senden</button>
  </div>

  <script>
    emailjs.init({ publicKey: "E4jHB9-hSCQJ6yEUf" });
    const API_BASE = "https://fritflix.dedyn.io:33420/api";
    const SPEEDTEST_TOKEN = "fhe9wzr83ezrw7ft72636770pueu9uft";
    let currentMsg = '', requireText = false;

    async function loadStatus() {
      try {
        const res = await fetch(`${API_BASE}/status`);
        const data = await res.json();
        const vpn = data.vpn || {};
        const speed = vpn.last_speedtest || { ping: 0, download: 0, upload: 0 };
        const dlPct = Math.min((speed.download / 90) * 100, 100);
        const ulPct = Math.min((speed.upload / 36) * 100, 100);

        document.getElementById("status-box").innerHTML = `
          <p><b>Server:</b> ${vpn.current_server || 'Unbekannt'} (Load: ${vpn.server_load_percent || 0}%)</p>
          <p><b>Auslastung:</b> ${data.load_percent || 0}% (${data.streams || 0} Streams, ${data.downloads || 0} Downloads)</p>
          <progress value="${(data.load_percent || 0)/100}" max="1" class="${(data.load_percent || 0) > 75 ? 'high' : ''}"></progress>
          <p><b>Speedtest:</b> Ping <b>${speed.ping || 0} ms</b></p>
          <p><b>DL:</b> <b>${speed.download || 0} Mbit/s</b></p>
          <progress value="${dlPct/100}" max="1" class="blue"></progress>
          <p><b>UL:</b> <b>${speed.upload || 0} Mbit/s</b></p>
          <progress value="${ulPct/100}" max="1" class="blue"></progress>
          <p><b>Wechsel:</b> ${vpn.switching_now ? 'L√§uft gerade!' : `Letzter: ${vpn.last_switch || 'Keiner'} um ${vpn.last_switch_time || ''}`}</p>
        `;
      } catch (e) {
        document.getElementById("status-box").innerHTML = `<p>Fehler: ${e.message}</p>`;
      }
    }

    async function runSpeedtest() {
      const btn = document.getElementById("speedtest-btn");
      btn.disabled = true;
      btn.classList.remove('success', 'error');
      btn.classList.add('loading');
      btn.innerHTML = 'L√§uft...';

      try {
        const res = await fetch(`${API_BASE}/speedtest/run`, {
          method: 'POST',
          headers: { 'X-Token': SPEEDTEST_TOKEN }
        });

        if (res.ok) {
          btn.classList.add('success');
          btn.innerHTML = 'Erfolgreich!';
          setTimeout(() => {
            loadStatus();
            btn.classList.remove('loading', 'success');
            btn.innerHTML = 'Speedtest starten';
            btn.disabled = false;
          }, 3000);
        } else {
          throw new Error("Serverfehler");
        }
      } catch (e) {
        btn.classList.add('error');
        btn.innerHTML = 'Fehlgeschlagen';
        setTimeout(() => {
          btn.classList.remove('loading', 'error');
          btn.innerHTML = 'Speedtest starten';
          btn.disabled = false;
        }, 3000);
      }
    }

    function openModal(msg, req = false) {
      currentMsg = msg; requireText = req;
      document.getElementById('modal-title').textContent = msg;
      document.getElementById('extra-text').value = '';
      document.getElementById('no-text-btn').style.display = req ? 'none' : 'block';
      document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function sendEmail(text) {
      const status = document.getElementById('status');
      status.textContent = 'Sende...';
      try {
        await emailjs.send('service_i3ceboq', 'template_3iie047', {
          feedback: text,
          timestamp: new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' })
        });
        status.textContent = 'Danke f√ºr dein Feedback!';
        setTimeout(() => status.textContent = '', 3000);
      } catch (e) {
        status.textContent = 'Fehler beim Senden.';
        setTimeout(() => status.textContent = '', 3000);
      }
    }

    function sendDirect(btn, msg) {
      const orig = btn.dataset.orig;
      btn.disabled = true;
      btn.innerHTML = 'Sende...';
      sendEmail(msg);
      setTimeout(() => {
        btn.innerHTML = orig;
        btn.disabled = false;
      }, 3000);
    }

    function sendWithText() {
      const txt = document.getElementById('extra-text').value.trim();
      if (requireText && !txt) return alert('Text erforderlich!');
      sendEmail(currentMsg + (txt ? ' ‚Äì ' + txt : ''));
      closeModal();
    }

    function sendWithoutText() {
      sendEmail(currentMsg);
      closeModal();
    }

    loadStatus();
    setInterval(loadStatus, 20000);
  </script>
</body>
</html>
