<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fritflix Feedback</title>
  <style>
    :root {
      --primary: #e50914;
      --primary-hover: #f41a22;
      --secondary: #333;
      --text: #fff;
      --bg: #111;
      --box-bg: #1b1b1b;
      --border: #444;
      --success: #28a745;
      --error: #dc3545;
      --blue: #1a73e8;
      --row-alt: #191919;
      --row-alt2: #212121;
      --badge: #ffcc00;
      --faq-green: #2e7d32;
      --faq-green-hover: #388e3c;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1em;
      text-align: center;
      min-height: 100vh;
      margin: 0;
      gap: 1em;
    }
    h1 { font-size: 1.8em; margin: 0.5em 0 0.2em; font-weight: 600; }

    /* Banner */
    #switch-banner {
      position: sticky;
      top: 0;
      z-index: 999;
      width: 95%;
      max-width: 420px;
      display: none;
      border-radius: 10px;
      padding: 0.6em 0.8em;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      font-weight: 800;
      letter-spacing: 0.3px;
      border: 1px solid #00000040;
    }
    #switch-banner .icon { font-size: 1.25em; margin-right: 0.4em; }
    #switch-banner.switching { background: linear-gradient(90deg, var(--badge), #ffaa00); color: #111; }
    #switch-banner.offline { background: linear-gradient(90deg, #ff5555, #ff2222); color: #fff; border-color: #00000070; }

    /* Status */
    details#status-details {
      width: 95%;
      max-width: 420px;
      background: var(--box-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    details#status-details > summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.6em;
      padding: 0.9em 1em;
      cursor: pointer;
      user-select: none;
      background: #202020;
    }
    details#status-details > summary::-webkit-details-marker { display: none; }
    .chev { transition: transform .2s ease; }
    details[open] .chev { transform: rotate(90deg); }
    .summary-row { display: flex; align-items: center; gap: 0.6em; width: 100%; justify-content: space-between; }
    .summary-left { display: flex; align-items: center; gap: 0.6em; font-weight: 600; }
    .summary-meta { font-size: .85em; opacity: .8; }
    .summary-bars { display: grid; grid-template-columns: 1fr; gap: 4px; width: 48%; }
    .mini-bar { height: 8px; background: #333; border-radius: 6px; overflow: hidden; }
    .mini-bar > span { display: block; height: 100%; background: var(--primary); }
    .mini-bar.blue > span { background: var(--blue); }
    #status-box {
      padding: 1.0em 1em 1.2em;
      text-align: left;
      font-size: 0.98em;
      line-height: 1.6;
      border-top: 1px solid var(--border);
      background: var(--box-bg);
    }
    progress {
      width: 100%; height: 16px; margin: 0.4em 0; border-radius: 10px; overflow: hidden;
    }
    progress::-webkit-progress-bar { background: #333; border-radius: 10px; }
    progress::-webkit-progress-value { background: var(--primary); border-radius: 10px; }
    progress.high::-webkit-progress-value { background: var(--error); }
    progress.blue::-webkit-progress-value { background: var(--blue); }

    .button-container {
      display: flex; flex-direction: column; gap: 0.7em; width: 95%; max-width: 420px;
    }
    .btn-row {
      display: flex; gap: 0.5em; width: 100%; padding: 0.25em; border-radius: 10px;
    }
    .btn-row:nth-child(odd) { background: var(--row-alt); }
    .btn-row:nth-child(even) { background: var(--row-alt2); }
    button {
      border: none; border-radius: 0.6em; cursor: pointer; transition: all 0.2s ease;
      font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.55em;
    }
    .feedback-btn {
      flex: 1; background: var(--primary); color: #fff; font-size: 1.05em;
      padding: 0.95em 0.8em; min-height: 54px;
    }
    .feedback-btn:hover { background: var(--primary-hover); }
    .feedback-btn:disabled { background: #666; cursor: not-allowed; }
    .note-btn {
      background: var(--secondary); color: #fff; font-size: 1.25em;
      width: 54px; min-height: 54px; padding: 0; display: flex; align-items: center; justify-content: center;
    }
    .note-btn:hover { background: #444; }

    .speedtest-btn, .faq-jump-btn {
      background: var(--blue); color: #fff; font-weight: 700;
      margin: 0.2em 0 0.8em; padding: 1.0em; font-size: 1.05em;
      border-radius: 0.6em; width: 95%; max-width: 420px;
    }
    .speedtest-btn:hover { background: #0d62c7; }
    .faq-jump-btn { background: var(--faq-green); margin: 0.8em 0 0.2em; }
    .faq-jump-btn:hover { background: var(--faq-green-hover); }

    .speedtest-btn.loading { background: #666; }
    .speedtest-btn.success { background: var(--success); }
    .speedtest-btn.error { background: var(--error); }

    #modal {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #333; padding: 1.0em 1.0em 1.2em; border-radius: 0.8em;
      width: 88%; max-width: 420px; z-index: 100; border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #modal h3 { margin: 0 0 0.7em; font-size: 1.2em; }
    #modal textarea {
      width: 100%; height: 110px; background: #444; color: #fff;
      border: 1px solid #666; border-radius: 0.5em; padding: 0.6em;
      font-size: 0.98em; resize: none;
    }
    #modal .modal-buttons { display: flex; flex-direction: column; gap: 0.8em; margin-top: 0.8em; }
    #modal .primary-full { width: 100%; }
    #modal .bottom-row { display: flex; gap: 0.6em; }
    #modal .bottom-row > button { flex: 1; }
    .subtle-btn { background: #2a2a2a; color: #dddddd; border: 1px solid #444; }
    .subtle-btn:hover { background: #353535; color: #ffffff; }

    /* === FAQ SECTION === */
    #faq-section {
      width: 95%;
      max-width: 420px;
      background: var(--box-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.8em 1em;
      margin-top: 0.5em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #faq-search {
      width: 100%; padding: 0.7em; background: #333; color: #fff;
      border: 1px solid #555; border-radius: 0.6em; margin-bottom: 0.8em;
      font-size: 0.95em;
    }
    .faq-item {
      margin-bottom: 0.6em;
    }
    .faq-item > summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.02em;
      padding: 0.75em 0;
      display: flex;
      align-items: center;
      gap: 0.5em;
      border-bottom: 1px solid #333;
    }
    .faq-item > summary::-webkit-details-marker { display: none; }
    .faq-item[open] > summary { border-bottom: none; padding-bottom: 0.5em; }
    .faq-item[open] > summary .chev { transform: rotate(90deg); }
    .faq-answer {
      font-size: 0.94em;
      line-height: 1.55;
      padding: 0.8em 0 1em 1.8em;
      border-bottom: 1px solid #333;
    }
    .faq-answer:last-child { border-bottom: none; }
    .faq-answer ol, .faq-answer ul { margin: 0.4em 0; padding-left: 1.4em; }
    .faq-answer li { margin-bottom: 0.3em; }
    .faq-answer a { color: var(--blue); text-decoration: underline; }

    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      .feedback-btn { font-size: 1em; padding: 0.9em 0.7em; min-height: 50px; }
      .note-btn { font-size: 1.2em; width: 50px; min-height: 50px; }
      .summary-bars { width: 50%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e50914">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Fritflix Feedback">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .catch(err => console.log('SW failed:', err));
      });
    }
  </script>
</head>
<body>
  <h1>Feedback zu Fritflix</h1>

  <!-- Banner -->
  <div id="switch-banner">
    <span class="icon">Warnung</span>
    <span id="switch-text">SERVERWECHSEL â€“ Verbindung wird umgeschaltetâ€¦</span>
  </div>

  <!-- Status -->
  <details id="status-details">
    <summary>
      <div class="summary-row">
        <div class="summary-left">
          <span class="chev">â–¶</span>
          <span id="summary-server">Server: â€“</span>
        </div>
        <div class="summary-bars">
          <div class="mini-bar" title="Auslastung"><span id="mini-load" style="width:0%"></span></div>
          <div class="mini-bar blue" title="DL"><span id="mini-dl" style="width:0%"></span></div>
          <div class="mini-bar blue" title="UL"><span id="mini-ul" style="width:0%"></span></div>
        </div>
      </div>
      <div class="summary-meta" id="summary-meta"></div>
    </summary>
    <div id="status-box">Lade Server-Statusâ€¦</div>
  </details>

  <!-- Speedtest Button -->
  <button id="speedtest-btn" class="speedtest-btn" onclick="runSpeedtest()">Speedtest starten</button>

  <!-- FAQ Button (unter Speedtest, grÃ¼n) -->
  <button class="faq-jump-btn" onclick="document.getElementById('faq-section').scrollIntoView({behavior:'smooth'})">
    FAQ â€“ HÃ¤ufige Fragen
  </button>

  <!-- Feedback Buttons -->
  <div class="button-container">
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â›” Server offline" onclick="sendDirect(this, 'â›” Server offline')">â›” Server offline</button>
      <button class="note-btn" onclick="openModal('Server offline')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ” Anmeldung nicht mÃ¶glich" onclick="sendDirect(this, 'ğŸ” Anmeldung nicht mÃ¶glich')">ğŸ” Anmeldung nicht mÃ¶glich</button>
      <button class="note-btn" onclick="openModal('Anmeldung nicht mÃ¶glich')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â¹ï¸ Stream startet nicht" onclick="sendDirect(this, 'â¹ï¸ Stream startet nicht')">â¹ï¸ Stream startet nicht</button>
      <button class="note-btn" onclick="openModal('Stream startet nicht')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸŒ Stream ruckelt" onclick="sendDirect(this, 'ğŸŒ Stream ruckelt')">ğŸŒ Stream ruckelt</button>
      <button class="note-btn" onclick="openModal('Stream ruckelt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â¸ï¸ Stream stoppt an bestimmter Stelle" onclick="sendDirect(this, 'â¸ï¸ Stream stoppt an bestimmter Stelle')">â¸ï¸ Stream stoppt an bestimmter Stelle</button>
      <button class="note-btn" onclick="openModal('Stream stoppt an bestimmter Stelle')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”‡ Kein Ton vorhanden" onclick="sendDirect(this, 'ğŸ”‡ Kein Ton vorhanden')">ğŸ”‡ Kein Ton vorhanden</button>
      <button class="note-btn" onclick="openModal('Kein Ton vorhanden')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ“ºâœ–ï¸ğŸ”Š Ton und Bild nicht synchron" onclick="sendDirect(this, 'ğŸ“ºâœ–ï¸ğŸ”Š Ton und Bild nicht synchron')">ğŸ“ºâœ–ï¸ğŸ”Š Ton und Bild nicht synchron</button>
      <button class="note-btn" onclick="openModal('Ton und Bild nicht synchron')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”ˆâœ–ï¸ Originaltonspur fehlt" onclick="sendDirect(this, 'ğŸ”ˆâœ–ï¸ Originaltonspur fehlt')">ğŸ”ˆâœ–ï¸ Originaltonspur fehlt</button>
      <button class="note-btn" onclick="openModal('Originaltonspur fehlt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ“ƒâœ–ï¸ Untertitel fehlen" onclick="sendDirect(this, 'ğŸ“ƒâœ–ï¸ Untertitel fehlen')">ğŸ“ƒâœ–ï¸ Untertitel fehlen</button>
      <button class="note-btn" onclick="openModal('Untertitel fehlen')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â³ Untertitel nicht synchron" onclick="sendDirect(this, 'â³ Untertitel nicht synchron')">â³ Untertitel nicht synchron</button>
      <button class="note-btn" onclick="openModal('Untertitel nicht synchron')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ‘¾ BildqualitÃ¤t schlecht (kein HD)" onclick="sendDirect(this, 'ğŸ‘¾ BildqualitÃ¤t schlecht (kein HD)')">ğŸ‘¾ BildqualitÃ¤t schlecht (kein HD)</button>
      <button class="note-btn" onclick="openModal('BildqualitÃ¤t schlecht (kein HD)')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”€ Falscher Film/Serie wird abgespielt" onclick="sendDirect(this, 'ğŸ”€ Falscher Film/Serie wird abgespielt')">ğŸ”€ Falscher Film/Serie wird abgespielt</button>
      <button class="note-btn" onclick="openModal('Falscher Film/Serie wird abgespielt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ’¥ App stÃ¼rzt ab" onclick="sendDirect(this, 'ğŸ’¥ App stÃ¼rzt ab')">ğŸ’¥ App stÃ¼rzt ab</button>
      <button class="note-btn" onclick="openModal('App stÃ¼rzt ab')">ğŸ“</button>
    </div>
  </div>

  <button class="feedback-btn" style="margin-top:0.6em;padding:1em;width:95%;max-width:420px;" onclick="openModal('Anderes Problem', true)">Anderes Problem</button>

  <!-- FAQ Section (aufklappbar!) -->
  <section id="faq-section">
    <input type="text" id="faq-search" placeholder="FAQ durchsuchenâ€¦" onkeyup="filterFAQ()">

    <!-- Aufklappbare FAQ-EintrÃ¤ge -->
    <details class="faq-item">
      <summary><span class="chev">â¡ï¸</span> Der Film oder die Serie ruckelt â€“ was tun?</summary>
      <div class="faq-answer">
        1. <b>QualitÃ¤t prÃ¼fen:</b> Direkt-Play? Mind. 20 Mbit/s nÃ¶tig. Wenn es ruckelt, Bitrate reduzieren (z. B. 8 â†’ 5 â†’ 3 Mbit/s), bis es flÃ¼ssig lÃ¤uft.<br>
        2. <b>Server-Auslastung prÃ¼fen:</b> Oben auf dieser Seite siehst du aktuelle Streams/Downloads. Ab 4 gleichzeitigen Nutzern kann es ruckeln.<br>
        3. <b>Speedtest durchfÃ¼hren:</b> Hier auf der Seite (Server-Seite) oder bei dir selbst, z. B. Ã¼ber <a href="https://www.google.com/search?q=speedtest" target="_blank">Google Speedtest</a>. Liegt der Server-Upload oder dein Download unter 20 Mbit/s â†’ Admin informieren (Serverwechsel oder zur vollen Stunde warten â€“ automatischer Wechsel).<br>
        4. <b>App neu starten.</b> Hilft nichts? â†’ Admin Bescheid sagen.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Ich kann mich nicht anmelden</summary>
      <div class="faq-answer">
        1. <b>Richtiges Passwort?</b> GroÃŸ-/Kleinschreibung beachten.<br>
        2. <b>Anderes GerÃ¤t angemeldet?</b> Oft kommt die Meldung â€Keine Berechtigungâ€œ. Auf dem anderen GerÃ¤t abmelden â†’ nur 1 Sitzung erlaubt.<br>
        3. <b>Profilbild grau?</b> Passwort 3Ã— falsch eingegeben â†’ Admin informieren.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Ich finde den Film/die Serie nicht</summary>
      <div class="faq-answer">
        1. <b>Schreibweise prÃ¼fen:</b> Genau eingeben, keine Leerzeichen vorne/hinten. Jellyfin kennt deutsche & englische Titel. Achtung: Umlaute (Ã¤, Ã¶, Ã¼) manchmal problematisch â†’ anderes Wort aus dem Titel nutzen.<br>
        2. <b>Nicht vorhanden?</b> â†’ Als Wunsch an den Admin schicken.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Ich kann das Intro nicht Ã¼berspringen</summary>
      <div class="faq-answer">
        1. Button â€Intro Ã¼berspringenâ€œ erscheint (bei Android TV: Kreis mit â€Ã¼berspringenâ€œ). Darauf klicken.<br>
        â†’ Intro-Skip wird automatisch generiert â€“ nicht immer perfekt. Alternativ: selbst vorspulen.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Der Film startet nicht</summary>
      <div class="faq-answer">
        1. <b>Geduld:</b> Besonders 4K-Filme brauchen bis zu 5 Min. Vorlaufzeit.<br>
        2. Jellyfin neu starten oder hier Server-Speed/Load prÃ¼fen.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Fehlermeldung: â€Nicht kompatibel mit Client/AbspielgerÃ¤tâ€œ</summary>
      <div class="faq-answer">
        1. Meist irrefÃ¼hrend â†’ Film hat zu lange geladen. PrÃ¼fe deine Internetgeschwindigkeit (Speedtest > 20 Mbit/s Download).<br>
        2. Film neu laden.<br>
        3. AuflÃ¶sung reduzieren (Jellyfin merkt sich die Einstellung).<br>
        4. GerÃ¤t wirklich inkompatibel? â†’ anderes GerÃ¤t testen.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Fehlermeldung: â€Kann nicht wiedergegeben werdenâ€œ</summary>
      <div class="faq-answer">
        1. Serverseitig: Externe Festplatte nicht erkannt â†’ Admin kontaktieren.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Ich sehe keine Sammlungen (Klick auf Sammlung â†’ nichts)</summary>
      <div class="faq-answer">
        Sammlungen laden bis zu 15 Sek. â†’ Geduld. Nach 30 Sek. nichts? Seite neu laden. Sonst: Admin kontaktieren.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Die Startseite lÃ¤dt nicht mehr</summary>
      <div class="faq-answer">
        App komplett neu installieren.
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Wo finde ich die Apps?</summary>
      <div class="faq-answer">
        â€¢ Smart TV: App Store â†’ â€Jellyfinâ€œ<br>
        â€¢ Android / iOS: Play Store / App Store â†’ â€Jellyfinâ€œ<br>
        â€¢ Fire TV Stick: Amazon Appstore â†’ â€Jellyfinâ€œ<br>
        â€¢ Apple TV: â€Swiftfinâ€œ<br>
        â€¢ PC: Jellyfin Media Player â†’ <a href="https://github.com/jellyfin/jellyfin-media-player/releases/tag/v1.12.0" target="_blank">Download (richtige Version wÃ¤hlen)</a>
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Wie melde ich mich an?</summary>
      <div class="faq-answer">
        1. Jellyfin-App auf TV, Tablet oder Fire TV Stick installieren. PC/Smartphone: Browser mÃ¶glich.<br>
        2. Server eingeben:<br>
        â†’ <code>https://fritflix.dedyn.io:33420</code><br>
        â†’ iPhone/iPad: <code>https://app.fritflix.dedyn.io:33420</code><br>
        3. Browser: Generalbenutzer + Passwort (aus WhatsApp-Gruppe).<br>
        4. Deinen Namen auswÃ¤hlen + Passwort (privat geschickt) â†’ einloggen.<br>
        5. Film/Serie auswÃ¤hlen â†’ Stream starten
      </div>
    </details>

    <details class="faq-item">
      <summary><span class="chev">â–¶</span> Der Server ist offline â€“ ich kann mich nicht verbinden</summary>
      <div class="faq-answer">
        1. <b>VPN aus?</b> Nur in Deutschland & Spanien erlaubt.<br>
        2. Zur vollen Stunde: VPN-Check â†’ bis zu 15 Min. offline. Status hier prÃ¼fen.<br>
        3. LÃ¤nger offline? â†’ Admin kontaktieren.
      </div>
    </details>
  </section>

  <!-- Modal -->
  <div id="modal">
    <h3 id="modal-title"></h3>
    <textarea id="extra-text" placeholder="ZusÃ¤tzliche Beschreibungâ€¦"></textarea>
    <div class="modal-buttons">
      <button id="btn-with-text" class="feedback-btn primary-full" onclick="sendWithText(this)">Senden mit Text</button>
      <div class="bottom-row">
        <button id="no-text-btn" class="subtle-btn" onclick="sendWithoutText(this)">Ohne Text senden</button>
        <button class="feedback-btn" style="background:#666;" onclick="closeModal()">Abbrechen</button>
      </div>
    </div>
  </div>

  <script>
    emailjs.init({ publicKey: "E4jHB9-hSCQJ6EUf" });
    const API_BASE = "https://fritflix.dedyn.io:33420/api";
    const SPEEDTEST_TOKEN = "fhe9wzr83ezrw7ft72636770pueu9uft";
    const OFFLINE_THRESHOLD_MS = 15 * 60 * 1000;
    const FETCH_TIMEOUT_MS = 10000;
    const FETCH_TIMEOUT_MS_SPEEDTEST = 120000;
    const SPEEDTEST_POLL_TIMEOUT_MS = 90000;
    const SPEEDTEST_POLL_INTERVAL_MS = 2000;
    const FETCH_TIMEOUT_MS_STATUS = 10000;
    const MAX_MEMORY_AGE_MS = 24 * 60 * 60 * 1000;
    const LS_LAST_SUCCESS = 'ff_last_success_ts';
    const LS_FAIL_SINCE = 'ff_fail_since_ts';

    function lsNum(key) {
      const v = localStorage.getItem(key);
      const n = v == null ? null : Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function probeLocation(timeoutMs = 5000) {
      try {
        const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(timeoutMs) });
        if (!res.ok) return null;
        const data = await res.json();
        const country = data.country_code || 'Unbekannt';
        const isAllowed = ['DE', 'ES'].includes(country);
        const isVPN = data.org?.toLowerCase().includes('vpn') || data.hosting || false;
        return { city: data.city || 'Unbekannt', country, allowed: isAllowed, vpn: isVPN };
      } catch { return null; }
    }

    async function probeInternetOK(timeoutMs = 4000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        await fetch('https://www.gstatic.com/generate_204', { mode: 'no-cors', signal: ctrl.signal });
        clearTimeout(t);
        return true;
      } catch {
        clearTimeout(t);
        return false;
      }
    }

    let currentMsg = '', requireText = false;
    let lastSuccessTs = null;
    let failSinceTs = null;

    (function initPersistedState() {
      const persistedFail = lsNum(LS_FAIL_SINCE);
      const persistedOk = lsNum(LS_LAST_SUCCESS);
      if (persistedFail && (Date.now() - persistedFail) <= MAX_MEMORY_AGE_MS) {
        failSinceTs = persistedFail;
      } else {
        localStorage.removeItem(LS_FAIL_SINCE);
      }
      if (persistedOk) lastSuccessTs = persistedOk;
    })();

    function fetchWithTimeout(url, opts = {}, ms = FETCH_TIMEOUT_MS) {
      return Promise.race([
        fetch(url, opts),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms))
      ]);
    }

    function setBanner(mode, extraText) {
      const banner = document.getElementById('switch-banner');
      const text = document.getElementById('switch-text');
      if (mode === 'hidden') {
        banner.style.display = 'none';
        banner.classList.remove('switching', 'offline');
        return;
      }
      banner.style.display = 'block';
      banner.classList.remove('switching', 'offline');
      if (mode === 'switching') {
        banner.classList.add('switching');
        text.textContent = extraText || 'SERVERWECHSEL â€“ Verbindung wird umgeschaltetâ€¦';
      } else if (mode === 'offline') {
        banner.classList.add('offline');
        text.textContent = extraText || 'Server offline. Bitte Administrator kontaktieren.';
      }
    }

    function setMiniBars(loadPct, dlPct, ulPct) {
      document.getElementById('mini-load').style.width = Math.min(loadPct, 100) + '%';
      document.getElementById('mini-dl').style.width = Math.min(dlPct, 100) + '%';
      document.getElementById('mini-ul').style.width = Math.min(ulPct, 100) + '%';
    }

    function setSummaryMeta(ts) {
      const el = document.getElementById('summary-meta');
      if (!ts) { el.textContent = ''; return; }
      const dt = new Date(ts);
      el.textContent = `Letzte Aktualisierung: ${dt.toLocaleTimeString('de-DE')}`;
    }

    async function loadStatus() {
      try {
        const res = await fetchWithTimeout(`${API_BASE}/status`);
        const data = await res.json();
        lastSuccessTs = Date.now();
        failSinceTs = null;
        localStorage.setItem(LS_LAST_SUCCESS, String(lastSuccessTs));
        localStorage.removeItem(LS_FAIL_SINCE);
        const vpn = data.vpn || {};
        const switching = !!vpn.switching_now;
        const speed = vpn.last_speedtest || { ping: 0, download: 0, upload: 0 };
        const dlPct = Math.min((speed.download / 90) * 100, 100);
        const ulPct = Math.min((speed.upload / 36) * 100, 100);
        const loadPct = Math.min(data.load_percent || 0, 100);
        const summaryEl = document.getElementById('summary-server');
        summaryEl.textContent = switching ? 'Server: Wechsel lÃ¤uftâ€¦' : `Server: ${vpn.current_server || 'Unbekannt'}`;
        if (switching) setBanner('switching'); else setBanner('hidden');
        setMiniBars(loadPct, dlPct, ulPct);
        setSummaryMeta(lastSuccessTs);
        document.getElementById('status-box').innerHTML = `
          <p><b>Server:</b> ${vpn.current_server || 'Unbekannt'} (Load: ${vpn.server_load_percent || 0}%)</p>
          <p><b>Auslastung:</b> ${data.load_percent || 0}% (${data.streams || 0} Streams, ${data.downloads || 0} Downloads)</p>
          <progress value="${(data.load_percent || 0)/100}" max="1" class="${(data.load_percent || 0) > 75 ? 'high' : ''}"></progress>
          <p><b>Speedtest:</b> Ping <b>${speed.ping || 0} ms</b></p>
          <p><b>DL:</b> <b>${speed.download || 0} Mbit/s</b></p>
          <progress value="${dlPct/100}" max="1" class="blue"></progress>
          <p><b>UL:</b> <b>${speed.upload || 0} Mbit/s</b></p>
          <progress value="${ulPct/100}" max="1" class="blue"></progress>
          <p><b>Wechsel:</b> ${switching
            ? '<span style="color:#111;background:var(--badge);padding:0.15em 0.45em;border-radius:6px;font-weight:800;">LÃ¤uft gerade!</span>'
            : `Letzter: ${vpn.last_switch || 'Keiner'} um ${vpn.last_switch_time || ''}`}</p>
        `;
      } catch (e) {
        console.warn("Status nicht abrufbar:", e);
        if (!failSinceTs) {
          const persistedFail = lsNum(LS_FAIL_SINCE);
          if (persistedFail && (Date.now() - persistedFail) <= MAX_MEMORY_AGE_MS) {
            failSinceTs = persistedFail;
          } else {
            failSinceTs = Date.now();
          }
        }
        localStorage.setItem(LS_FAIL_SINCE, String(failSinceTs));
        const lastSuccessPersisted = lsNum(LS_LAST_SUCCESS);
        setSummaryMeta(lastSuccessPersisted || lastSuccessTs);
        document.getElementById('summary-server').textContent = 'Server: (unbekannt)';
        const elapsed = Date.now() - failSinceTs;
        const isOffline = elapsed >= OFFLINE_THRESHOLD_MS;
        if (isOffline) {
          setBanner('offline', 'Server offline â€“ bitte Administrator kontaktieren.');
        } else {
          setBanner('switching', 'SERVERWECHSEL â€“ Verbindung wird umgeschaltetâ€¦');
        }
        (async () => {
          const internetOK = await probeInternetOK();
          let extra = '';
          if (!internetOK) {
            extra = `<p>Hinweis: Deine Internetverbindung scheint aktuell gestÃ¶rt.</p>`;
          } else {
            const loc = await probeLocation();
            if (loc && !loc.allowed) {
              extra = `<p><strong>Zugriff nur aus Deutschland oder Spanien mÃ¶glich.</strong> Dein Standort: ${loc.city}, ${loc.country}${loc.vpn ? ' (VPN erkannt)' : ''}.</p>`;
            } else if (loc && loc.vpn) {
              extra = `<p>Hinweis: MÃ¶glicherweise nutzt du ein VPN â€“ Verbindung kÃ¶nnte eingeschrÃ¤nkt sein.</p>`;
            }
          }
          const base = isOffline
            ? `<p><b>Server offline.</b> Bitte Administrator kontaktieren.</p>`
            : `<p>Verbindeâ€¦ (${Math.floor(elapsed/1000)} s ohne Antwort)</p>`;
          const speedBtn = document.getElementById('speedtest-btn');
          if (!internetOK) {
            speedBtn.innerHTML = `Speedtest<br><small>Internet gestÃ¶rt</small>`;
          } else {
            speedBtn.innerHTML = `Speedtest<br><small>Server nicht erreichbar</small>`;
          }
          document.getElementById('status-box').innerHTML = base + extra;
        })();
        setInterval(() => {
          if (failSinceTs) {
            const elapsed = Date.now() - failSinceTs;
            if (elapsed >= OFFLINE_THRESHOLD_MS) setBanner('offline');
          }
        }, 5000);
      }
    }

    async function getStatusSafe() {
      const res = await fetchWithTimeout(`${API_BASE}/status`, {}, FETCH_TIMEOUT_MS_STATUS);
      return res.json();
    }

    async function runSpeedtest() {
      const btn = document.getElementById('speedtest-btn');
      setBtnState(btn, 'Wird geprÃ¼ftâ€¦', true);
      btn.classList.remove('success', 'error');
      btn.classList.add('loading');
      let prevTs = null;
      let prevSpeed = { download: 0, upload: 0, ping: 0 };
      try {
        const before = await getStatusSafe();
        const speed = before?.vpn?.last_speedtest;
        if (speed) {
          prevTs = speed.timestamp || null;
          prevSpeed = { download: speed.download || 0, upload: speed.upload || 0, ping: speed.ping || 0 };
        }
      } catch {}
      let pollCount = 0;
      let pollTimer = null;
      try {
        const res = await fetchWithTimeout(`${API_BASE}/speedtest/run`, {
          method: 'POST',
          headers: { 'X-Token': SPEEDTEST_TOKEN, 'Accept': 'application/json' }
        }, FETCH_TIMEOUT_MS_SPEEDTEST);
        let data = null;
        try {
          const ct = res.headers.get('content-type') || '';
          if (ct.includes('application/json')) data = await res.json();
        } catch {}
        if (data && data.success === true) {
          btn.classList.remove('loading');
          setBtnState(btn, 'LÃ¤uftâ€¦ (~60 s)', true);
          pollTimer = setInterval(() => {
            pollCount++;
            setBtnState(btn, `LÃ¤uftâ€¦ (~60 s) (${pollCount * 2}s)`, true);
          }, SPEEDTEST_POLL_INTERVAL_MS);
          await pollForResult();
          return;
        }
        if (res.ok || res.status === 202) {
          btn.classList.remove('loading');
          setBtnState(btn, 'LÃ¤uftâ€¦ (~60 s)', true);
          pollTimer = setInterval(() => {
            pollCount++;
            setBtnState(btn, `LÃ¤uftâ€¦ (~60 s) (${pollCount * 2}s)`, true);
          }, SPEEDTEST_POLL_INTERVAL_MS);
          await pollForResult();
          return;
        }
        throw new Error(`HTTP ${res.status}`);
      } catch (e) {
        if (String(e.message).toLowerCase().includes('timeout')) {
          btn.classList.remove('loading');
          setBtnState(btn, 'LÃ¤uftâ€¦ (Timeout, prÃ¼fe Ergebnis)', true);
          pollTimer = setInterval(() => {
            pollCount++;
            setBtnState(btn, `LÃ¤uftâ€¦ (~63 s) (${pollCount * 2}s)`, true);
          }, SPEEDTEST_POLL_INTERVAL_MS);
          await pollForResult();
          return;
        }
        console.error('Speedtest Fehler:', e);
        btn.classList.remove('loading');
        btn.classList.add('error');
        setBtnState(btn, 'Fehlgeschlagen', true);
      } finally {
        setTimeout(() => {
          if (pollTimer) clearInterval(pollTimer);
          setBtnState(btn, 'Speedtest starten', false);
          btn.classList.remove('success', 'error', 'loading');
        }, 2000);
      }
      async function pollForResult() {
        const t0 = Date.now();
        let seenUpdate = false;
        let lastSpeed = null;
        try {
          const initial = await getStatusSafe();
          lastSpeed = initial?.vpn?.last_speedtest;
        } catch {}
        while (Date.now() - t0 < SPEEDTEST_POLL_TIMEOUT_MS) {
          await new Promise(r => setTimeout(r, SPEEDTEST_POLL_INTERVAL_MS));
          try {
            const now = await getStatusSafe();
            const currentSpeed = now?.vpn?.last_speedtest;
            if (!currentSpeed) continue;
            const tsChanged = prevTs && currentSpeed.timestamp && currentSpeed.timestamp !== prevTs;
            const valuesChanged = lastSpeed && (
              currentSpeed.download !== lastSpeed.download ||
              currentSpeed.upload !== lastSpeed.upload ||
              currentSpeed.ping !== lastSpeed.ping
            );
            if (tsChanged || valuesChanged || (!lastSpeed && currentSpeed.download > 0)) {
              if (pollTimer) clearInterval(pollTimer);
              btn.classList.add('success');
              setBtnState(btn, 'Erfolgreich! Danke!', true);
              await loadStatus();
              seenUpdate = true;
              break;
            }
            lastSpeed = currentSpeed;
          } catch {}
        }
        if (!seenUpdate) {
          if (pollTimer) clearInterval(pollTimer);
          btn.classList.add('error');
          setBtnState(btn, 'Fehlgeschlagen (kein Ergebnis)', true);
        }
      }
    }

    function setBtnState(btn, label, disabled) {
      btn.innerHTML = label;
      btn.disabled = !!disabled;
    }

    async function sendViaEmailJS(text) {
      return emailjs.send('service_i3ceboq', 'template_3iie047', {
        feedback: text,
        timestamp: new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' })
      });
    }

    async function sendDirect(btn, msg) {
      const orig = btn.getAttribute('data-orig') || btn.innerHTML;
      setBtnState(btn, 'Sendeâ€¦', true);
      try {
        await sendViaEmailJS(msg);
        setBtnState(btn, 'Danke fÃ¼r dein Feedback!', true);
      } catch (e) {
        setBtnState(btn, 'Fehler â€“ erneut versuchen?', false);
        return;
      }
      setTimeout(() => {
        btn.innerHTML = orig;
        btn.disabled = false;
      }, 1800);
    }

    function openModal(msg, req = false) {
      currentMsg = msg;
      requireText = req;
      document.getElementById('modal-title').textContent = msg;
      document.getElementById('extra-text').value = '';
      document.getElementById('no-text-btn').style.display = req ? 'none' : 'block';
      document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function sendWithText(btnEl) {
      const txt = document.getElementById('extra-text').value.trim();
      if (requireText && !txt) {
        alert('Text erforderlich!');
        return;
      }
      const full = currentMsg + (txt ? ' â€“ ' + txt : '');
      const orig = btnEl.innerHTML;
      setBtnState(btnEl, 'Sendeâ€¦', true);
      try {
        await sendViaEmailJS(full);
        setBtnState(btnEl, 'Danke fÃ¼r dein Feedback!', true);
        setTimeout(() => {
          closeModal();
          btnEl.innerHTML = orig;
          btnEl.disabled = false;
        }, 900);
      } catch (e) {
        setBtnState(btnEl, 'Fehler â€“ erneut?', false);
      }
    }

    async function sendWithoutText(btnEl) {
      const orig = btnEl.innerHTML;
      setBtnState(btnEl, 'Sendeâ€¦', true);
      try {
        await sendViaEmailJS(currentMsg);
        setBtnState(btnEl, 'Danke fÃ¼r dein Feedback!', true);
        setTimeout(() => {
          closeModal();
          btnEl.innerHTML = orig;
          btnEl.disabled = false;
        }, 900);
      } catch (e) {
        setBtnState(btnEl, 'Fehler â€“ erneut?', false);
      }
    }

    // FAQ Live-Suche
    function filterFAQ() {
      const query = document.getElementById('faq-search').value.toLowerCase();
      const items = document.querySelectorAll('.faq-item');
      items.forEach(item => {
        const question = item.querySelector('summary').textContent.toLowerCase();
        const answer = item.querySelector('.faq-answer').textContent.toLowerCase();
        const visible = question.includes(query) || answer.includes(query);
        item.style.display = visible ? '' : 'none';
      });
    }

    // Init
    loadStatus();
    setInterval(loadStatus, 20000);
  </script>
</body>
</html>
