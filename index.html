<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fritflix Feedback</title>
  <style>
    :root {
      --primary: #e50914;
      --primary-hover: #f41a22;
      --secondary: #333;
      --text: #fff;
      --bg: #111;
      --box-bg: #1b1b1b;
      --border: #444;
      --success: #28a745;
      --error: #dc3545;
      --blue: #1a73e8;
      --row-alt: #191919;
      --row-alt2: #212121;
      --badge: #ffcc00;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1em;
      text-align: center;
      min-height: 100vh;
      margin: 0;
      gap: 1em;
    }

    h1 { font-size: 1.8em; margin: 0.5em 0 0.2em; font-weight: 600; }

    /* Immer sichtbarer Serverwechsel-/Offline-Banner */
    #switch-banner { position: sticky; top: 0; z-index: 999; width: 95%; max-width: 420px; display: none; border-radius: 10px; padding: 0.6em 0.8em; box-shadow: 0 4px 10px rgba(0,0,0,0.35); font-weight: 800; letter-spacing: 0.3px; border: 1px solid #00000040; }
    #switch-banner .icon { font-size: 1.25em; margin-right: 0.4em; }
    #switch-banner.switching { background: linear-gradient(90deg, var(--badge), #ffaa00); color: #111; }
    #switch-banner.offline { background: linear-gradient(90deg, #ff5555, #ff2222); color: #fff; border-color: #00000070; }

    /* Ausklappbarer Status-Block */
    details#status-details { width: 95%; max-width: 420px; background: var(--box-bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    details#status-details > summary { list-style: none; display: flex; align-items: center; gap: 0.6em; padding: 0.9em 1em; cursor: pointer; user-select: none; background: #202020; }
    details#status-details > summary::-webkit-details-marker { display: none; }
    .chev { transition: transform .2s ease; }
    details[open] .chev { transform: rotate(90deg); }
    .summary-row { display: flex; align-items: center; gap: 0.6em; width: 100%; justify-content: space-between; }
    .summary-left { display: flex; align-items: center; gap: 0.6em; font-weight: 600; }
    .summary-meta { font-size: .85em; opacity: .8; }
    .summary-bars { display: grid; grid-template-columns: 1fr; gap: 4px; width: 48%; }
    .mini-bar { height: 8px; background: #333; border-radius: 6px; overflow: hidden; }
    .mini-bar > span { display: block; height: 100%; background: var(--primary); }
    .mini-bar.blue > span { background: var(--blue); }

    #status-box { padding: 1.0em 1em 1.2em; text-align: left; font-size: 0.98em; line-height: 1.6; border-top: 1px solid var(--border); background: var(--box-bg); }

    progress { width: 100%; height: 16px; margin: 0.4em 0; border-radius: 10px; overflow: hidden; }
    progress::-webkit-progress-bar { background: #333; border-radius: 10px; }
    progress::-webkit-progress-value { background: var(--primary); border-radius: 10px; }
    progress.high::-webkit-progress-value { background: var(--error); }
    progress.blue::-webkit-progress-value { background: var(--blue); }

    .button-container { display: flex; flex-direction: column; gap: 0.7em; width: 95%; max-width: 420px; }
    .btn-row { display: flex; gap: 0.5em; width: 100%; padding: 0.25em; border-radius: 10px; }
    .btn-row:nth-child(odd) { background: var(--row-alt); }
    .btn-row:nth-child(even) { background: var(--row-alt2); }

    button { border: none; border-radius: 0.6em; cursor: pointer; transition: all 0.2s ease; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.55em; }
    .feedback-btn { flex: 1; background: var(--primary); color: #fff; font-size: 1.05em; padding: 0.95em 0.8em; min-height: 54px; }
    .feedback-btn:hover { background: var(--primary-hover); }
    .feedback-btn:disabled { background: #666; cursor: not-allowed; }

    .note-btn { background: var(--secondary); color: #fff; font-size: 1.25em; width: 54px; min-height: 54px; padding: 0; display: flex; align-items: center; justify-content: center; }
    .note-btn:hover { background: #444; }

    .speedtest-btn { background: var(--blue); color: #fff; font-weight: 700; margin: 0.2em 0 0.8em; padding: 1.0em; font-size: 1.05em; border-radius: 0.6em; width: 95%; max-width: 420px; }
    .speedtest-btn:hover { background: #0d62c7; }
    .speedtest-btn.loading { background: #666; }
    .speedtest-btn.success { background: var(--success); }
    .speedtest-btn.error { background: var(--error); }

    #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 1.0em 1.0em 1.2em; border-radius: 0.8em; width: 88%; max-width: 420px; z-index: 100; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    #modal h3 { margin: 0 0 0.7em; font-size: 1.2em; }
    #modal textarea { width: 100%; height: 110px; background: #444; color: #fff; border: 1px solid #666; border-radius: 0.5em; padding: 0.6em; font-size: 0.98em; resize: none; }
    #modal .modal-buttons { display: flex; flex-direction: column; gap: 0.8em; margin-top: 0.8em; }
#modal .primary-full { width: 100%; }
#modal .bottom-row { display: flex; gap: 0.6em; }
#modal .bottom-row > button { flex: 1; }
/* dezenter Stil fÃ¼r "Ohne Text senden" */
.subtle-btn { background: #2a2a2a; color: #dddddd; border: 1px solid #444; }
.subtle-btn:hover { background: #353535; color: #ffffff; }
    #modal .main-row { display: flex; gap: 0.5em; width: 100%; justify-content: center; }
    #modal .main-row button { flex: 1; max-width: none; }

    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      .feedback-btn { font-size: 1em; padding: 0.9em 0.7em; min-height: 50px; }
      .note-btn { font-size: 1.2em; width: 50px; min-height: 50px; }
      .summary-bars { width: 50%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <h1>Feedback zu Fritflix</h1>

  <!-- Immer sichtbarer Banner -->
  <div id="switch-banner" class="switching"><span class="icon">â—</span><span id="switch-text">SERVERWECHSEL â€“ Verbindung wird umgeschaltetâ€¦</span></div>

  <!-- Ausklappbarer Status -->
  <details id="status-details">
    <summary>
      <div class="summary-row">
        <div class="summary-left">
          <span class="chev">â–¶</span>
          <span id="summary-server">Server: â€“</span>
        </div>
        <div class="summary-bars">
          <div class="mini-bar" title="Auslastung"><span id="mini-load" style="width:0%"></span></div>
          <div class="mini-bar blue" title="DL"><span id="mini-dl" style="width:0%"></span></div>
          <div class="mini-bar blue" title="UL"><span id="mini-ul" style="width:0%"></span></div>
        </div>
      </div>
      <div class="summary-meta" id="summary-meta"></div>
    </summary>
    <div id="status-box">Lade Server-Statusâ€¦</div>
  </details>

  <!-- Speedtest Button -->
  <button id="speedtest-btn" class="speedtest-btn" onclick="runSpeedtest()">â±ï¸ Speedtest starten</button>

  <!-- Feedback Buttons -->
  <div class="button-container">
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â›”ï¸ Server offline" onclick="sendDirect(this, 'Server offline')">â›”ï¸ Server offline</button>
      <button class="note-btn" onclick="openModal('Server offline')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ” Anmeldung nicht mÃ¶glich" onclick="sendDirect(this, 'Anmeldung nicht mÃ¶glich')">ğŸ” Anmeldung nicht mÃ¶glich</button>
      <button class="note-btn" onclick="openModal('Anmeldung nicht mÃ¶glich')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â–¶ï¸âŒ Stream startet nicht" onclick="sendDirect(this, 'Stream startet nicht')">â–¶ï¸âŒ Stream startet nicht</button>
      <button class="note-btn" onclick="openModal('Stream startet nicht')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ¢ Stream ruckelt" onclick="sendDirect(this, 'Stream ruckelt')">ğŸ¢ Stream ruckelt</button>
      <button class="note-btn" onclick="openModal('Stream ruckelt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â¸ï¸ Stream stoppt an bestimmter Stelle" onclick="sendDirect(this, 'Stream stoppt an bestimmter Stelle')">â¸ï¸ Stream stoppt an bestimmter Stelle</button>
      <button class="note-btn" onclick="openModal('Stream stoppt an bestimmter Stelle')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”‡ Kein Ton vorhanden" onclick="sendDirect(this, 'Kein Ton vorhanden')">ğŸ”‡ Kein Ton vorhanden</button>
      <button class="note-btn" onclick="openModal('Kein Ton vorhanden')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â±ï¸ Ton und Bild nicht synchron" onclick="sendDirect(this, 'Ton und Bild nicht synchron')">â±ï¸ Ton und Bild nicht synchron</button>
      <button class="note-btn" onclick="openModal('Ton und Bild nicht synchron')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸµâŒ Originaltonspur fehlt" onclick="sendDirect(this, 'Originaltonspur fehlt')">ğŸµâŒ Originaltonspur fehlt</button>
      <button class="note-btn" onclick="openModal('Originaltonspur fehlt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ“âŒ Untertitel fehlen" onclick="sendDirect(this, 'Untertitel fehlen')">ğŸ“âŒ Untertitel fehlen</button>
      <button class="note-btn" onclick="openModal('Untertitel fehlen')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â³ Untertitel nicht synchron" onclick="sendDirect(this, 'Untertitel nicht synchron')">â³ Untertitel nicht synchron</button>
      <button class="note-btn" onclick="openModal('Untertitel nicht synchron')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="HDâŒ BildqualitÃ¤t schlecht (kein HD)" onclick="sendDirect(this, 'BildqualitÃ¤t schlecht (kein HD)')">HDâŒ BildqualitÃ¤t schlecht (kein HD)</button>
      <button class="note-btn" onclick="openModal('BildqualitÃ¤t schlecht (kein HD)')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”€ Falscher Film/Serie wird abgespielt" onclick="sendDirect(this, 'Falscher Film/Serie wird abgespielt')">ğŸ”€ Falscher Film/Serie wird abgespielt</button>
      <button class="note-btn" onclick="openModal('Falscher Film/Serie wird abgespielt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ’¥ App stÃ¼rzt ab" onclick="sendDirect(this, 'App stÃ¼rzt ab')">ğŸ’¥ App stÃ¼rzt ab</button>
      <button class="note-btn" onclick="openModal('App stÃ¼rzt ab')">ğŸ“</button>
    </div>
  </div>

  <button class="feedback-btn" style="margin-top:0.6em;padding:1em;width:95%;max-width:420px;" onclick="openModal('Anderes Problem', true)">â• Anderes Problem</button>

  <!-- Modal -->
  <div id="modal">
    <h3 id="modal-title"></h3>
    <textarea id="extra-text" placeholder="ZusÃ¤tzliche Beschreibungâ€¦"></textarea>
    <div class="modal-buttons">
      <!-- Senden mit Text: nimmt die komplette Breite ein -->
      <button id="btn-with-text" class="feedback-btn primary-full" onclick="sendWithText(this)">ğŸ“¨ Senden mit Text</button>
      <!-- Unten: Ohne Text + Abbrechen teilen sich die Zeile -->
      <div class="bottom-row">
        <button id="no-text-btn" class="subtle-btn" onclick="sendWithoutText(this)">ğŸ“¨ Ohne Text senden</button>
        <button class="feedback-btn" style="background:#666;" onclick="closeModal()">Abbrechen</button>
      </div>
    </div>
  </div>
      <button id="no-text-btn" class="feedback-btn" onclick="sendWithoutText(this)">ğŸ“¨ Ohne Text senden</button>
    </div>
  </div>

  <script>
    emailjs.init({ publicKey: "E4jHB9-hSCQJ6yEUf" });
    const API_BASE = "https://fritflix.dedyn.io:33420/api";
    const SPEEDTEST_TOKEN = "fhe9wzr83ezrw7ft72636770pueu9uft";

    const OFFLINE_THRESHOLD_MS = 15 * 60 * 1000; // 15 Minuten
    const FETCH_TIMEOUT_MS = 10000; // 10s Timeout pro Request
    const FETCH_TIMEOUT_MS_SPEEDTEST = 120000;  // /speedtest/run (2 min Puffer)
    const SPEEDTEST_POLL_TIMEOUT_MS  = 90000;    // max. 90s auf neues Ergebnis warten
    const SPEEDTEST_POLL_INTERVAL_MS = 2000;     // alle 2s nachsehen

    let currentMsg = '', requireText = false;
    let lastSuccessTs = null;     // Zeitpunkt des letzten erfolgreichen Status
    let failSinceTs = null;       // Zeitpunkt, ab dem keine Verbindung mehr mÃ¶glich war

    // Utility: Fetch mit Timeout
    function fetchWithTimeout(url, opts = {}, ms = FETCH_TIMEOUT_MS) {
      return Promise.race([
        fetch(url, opts),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms))
      ]);
    }

    // Banner steuern
    function setBanner(mode, extraText) {
      const banner = document.getElementById('switch-banner');
      const text = document.getElementById('switch-text');
      if (mode === 'hidden') { banner.style.display = 'none'; banner.classList.remove('switching','offline'); return; }
      banner.style.display = 'block';
      banner.classList.remove('switching','offline');
      if (mode === 'switching') {
        banner.classList.add('switching');
        text.textContent = extraText || 'SERVERWECHSEL â€“ Verbindung wird umgeschaltetâ€¦';
      } else if (mode === 'offline') {
        banner.classList.add('offline');
        text.textContent = extraText || 'Server offline. Bitte Administrator kontaktieren.';
      }
    }

    // Mini-Balken aktualisieren
    function setMiniBars(loadPct, dlPct, ulPct) {
      document.getElementById('mini-load').style.width = Math.min(loadPct,100)+'%';
      document.getElementById('mini-dl').style.width   = Math.min(dlPct,100)+'%';
      document.getElementById('mini-ul').style.width   = Math.min(ulPct,100)+'%';
    }

    function setSummaryMeta(ts) {
      const el = document.getElementById('summary-meta');
      if (!ts) { el.textContent = ''; return; }
      const dt = new Date(ts);
      el.textContent = `Letzte Aktualisierung: ${dt.toLocaleTimeString('de-DE')}`;
    }

    async function loadStatus() {
      try {
        const res = await fetchWithTimeout(`${API_BASE}/status`);
        const data = await res.json();

        // Erfolg â†’ Watchdog zurÃ¼cksetzen
        lastSuccessTs = Date.now();
        failSinceTs = null;

        const vpn = data.vpn || {};
        const speed = vpn.last_speedtest || { ping: 0, download: 0, upload: 0 };
        const dlPct = Math.min((speed.download/90)*100, 100);
        const ulPct = Math.min((speed.upload/36)*100, 100);
        const loadPct = Math.min(data.load_percent || 0, 100);

        // Banner: wenn Backend sagt switching_now â†’ switching, sonst verstecken
        if (vpn.switching_now) setBanner('switching'); else setBanner('hidden');

        // Summary + Mini-Balken
        document.getElementById('summary-server').textContent = `Server: ${vpn.current_server || 'Unbekannt'}`;
        setMiniBars(loadPct, dlPct, ulPct);
        setSummaryMeta(lastSuccessTs);

        // Detail-Box
        document.getElementById('status-box').innerHTML = `
          <p><b>Server:</b> ${vpn.current_server || 'Unbekannt'} (Load: ${vpn.server_load_percent || 0}%)</p>
          <p><b>Auslastung:</b> ${data.load_percent || 0}% (${data.streams || 0} Streams, ${data.downloads || 0} Downloads)</p>
          <progress value="${(data.load_percent || 0)/100}" max="1" class="${(data.load_percent || 0) > 75 ? 'high' : ''}"></progress>
          <p><b>Speedtest:</b> Ping <b>${speed.ping || 0} ms</b></p>
          <p><b>DL:</b> <b>${speed.download || 0} Mbit/s</b></p>
          <progress value="${dlPct/100}" max="1" class="blue"></progress>
          <p><b>UL:</b> <b>${speed.upload || 0} Mbit/s</b></p>
          <progress value="${ulPct/100}" max="1" class="blue"></progress>
          <p><b>Wechsel:</b> ${vpn.switching_now ? '<span style="color:#111;background:var(--badge);padding:0.15em 0.45em;border-radius:6px;font-weight:800;">LÃ¤uft gerade!</span>' : `Letzter: ${vpn.last_switch || 'Keiner'} um ${vpn.last_switch_time || ''}`}</p>
        `;
      } catch (e) {
        // Fehlschlag â†’ ggf. Startzeit setzen und Banner auf SWITCHING stellen
        if (!failSinceTs) failSinceTs = Date.now();
        setSummaryMeta(lastSuccessTs);

        // Wenn noch unter 15 Minuten ohne Erfolg â†’ SWITCHING anzeigen
        const elapsed = Date.now() - failSinceTs;
        if (elapsed < OFFLINE_THRESHOLD_MS) {
          setBanner('switching', 'SERVERWECHSEL â€“ Verbindung wird umgeschaltetâ€¦');
          document.getElementById('status-box').innerHTML = `<p>Verbindeâ€¦ (${Math.floor(elapsed/1000)}s ohne Antwort)</p>`;
        } else {
          setBanner('offline');
          document.getElementById('status-box').innerHTML = `<p><b>Server offline.</b> Bitte Administrator kontaktieren.</p>`;
        }
      }
    }

    // Watchdog prÃ¼ft alle 5s, ob die 15-Minuten-Schwelle Ã¼berschritten ist
    setInterval(() => {
      if (failSinceTs) {
        const elapsed = Date.now() - failSinceTs;
        if (elapsed >= OFFLINE_THRESHOLD_MS) setBanner('offline');
      }
    }, 5000);
    
// kleine Helfer
async function getStatusSafe() {
  const res = await fetchWithTimeout(`${API_BASE}/status`, {}, FETCH_TIMEOUT_MS_STATUS);
  return res.json();
}

function getSpeedTimestamp(data) {
  // erwartet deine /status-Struktur: data.vpn.last_speedtest.timestamp
  return data?.vpn?.last_speedtest?.timestamp || null;
}

async function runSpeedtest() {
  const btn = document.getElementById('speedtest-btn');
  setBtnState(btn, 'â³ LÃ¤uftâ€¦ (~60 s)', true);
  btn.classList.remove('success','error');
  btn.classList.add('loading');

  // 1) Vorherigen Mess-TS merken (robust gegen Rundungs-Kollisionen)
  let prevTs = null;
  try {
    const before = await getStatusSafe();
    prevTs = getSpeedTimestamp(before);
  } catch { /* Wenn /status kurz nicht erreichbar ist, trotzdem weitermachen */ }

  try {
    // 2) Speedtest triggern â€” mit LANGEM Timeout
    const res = await fetchWithTimeout(`${API_BASE}/speedtest/run`, {
      method: 'POST',
      headers: { 'X-Token': SPEEDTEST_TOKEN, 'Accept': 'application/json' }
    }, FETCH_TIMEOUT_MS_SPEEDTEST);

    // 3) JSON versuchen (aber nicht erzwingen)
    let data = null;
    try {
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) data = await res.json();
    } catch { /* egal */ }

    // 4) Erfolgskriterien:
    //    a) API sagt success:true -> sofort Erfolg
    //    b) 2xx/202 ohne JSON -> "gestartet" und dann auf Log warten
    if (data && data.success === true) {
      btn.classList.remove('loading'); btn.classList.add('success');
      setBtnState(btn, 'âœ… Erfolgreich! Danke!', true);

      // Status nachziehen (manchmal schreibt das Log minimal verzÃ¶gert)
      loadStatus();
      setTimeout(loadStatus, 3000);
    } else if (res.ok || res.status === 202) {
      btn.classList.remove('loading'); btn.classList.add('success');
      setBtnState(btn, 'âœ… Gestartetâ€¦', true);

      // 5) Auf neues Ergebnis im /status warten (per Timestamp)
      const t0 = Date.now();
      let seenUpdate = false;
      while (Date.now() - t0 < SPEEDTEST_POLL_TIMEOUT_MS) {
        await new Promise(r => setTimeout(r, SPEEDTEST_POLL_INTERVAL_MS));
        try {
          const now = await getStatusSafe();
          const currTs = getSpeedTimestamp(now);
          if (currTs && currTs !== prevTs) {
            setBtnState(btn, 'âœ… Erfolgreich! Danke!', true);
            await loadStatus();
            seenUpdate = true;
            break;
          }
        } catch { /* still retrying */ }
      }
      if (!seenUpdate) {
        // Kein sichtbares Log, aber Start war ok â†’ freundlich bleiben
        setBtnState(btn, 'âœ… Gestartet (wird protokolliert)â€¦', true);
        setTimeout(loadStatus, 3000);
      }
    } else {
      throw new Error(`HTTP ${res.status}`);
    }
  } catch (e) {
    // 6) Timeout-Recovery: Wenn NUR der POST getimed out ist,
    //    warten wir noch etwas aufs Log, bevor wir "Fehlgeschlagen" zeigen.
    if (String(e.message).toLowerCase().includes('timeout')) {
      setBtnState(btn, 'âœ… Gestartetâ€¦ (warte auf Ergebnis)', true);
      btn.classList.remove('loading'); btn.classList.add('success');

      const t0 = Date.now();
      let recovered = false;
      while (Date.now() - t0 < SPEEDTEST_POLL_TIMEOUT_MS) {
        await new Promise(r => setTimeout(r, SPEEDTEST_POLL_INTERVAL_MS));
        try {
          const now = await getStatusSafe();
          const currTs = getSpeedTimestamp(now);
          if (currTs && currTs !== prevTs) {
            setBtnState(btn, 'âœ… Erfolgreich! Danke!', true);
            await loadStatus();
            recovered = true;
            break;
          }
        } catch {}
      }
      if (!recovered) {
        btn.classList.add('error');
        setBtnState(btn, 'âŒ Fehlgeschlagen (Timeout)', true);
      }
    } else {
      console.error('Speedtest Fehler:', e);
      btn.classList.remove('loading'); btn.classList.add('error');
      setBtnState(btn, 'âŒ Fehlgeschlagen', true);
    }
  } finally {
    // 7) Button nach kurzer Zeit zurÃ¼cksetzen
    setTimeout(() => {
      setBtnState(btn, 'â±ï¸ Speedtest starten', false);
      btn.classList.remove('success','error');
    }, 2000);
  }
}
    
    // Einheitlicher Button-State
    function setBtnState(btn, label, disabled) {
  btn.innerHTML = label;
  btn.disabled = !!disabled;
}

    async function sendViaEmailJS(text) {
      return emailjs.send('service_i3ceboq', 'template_3iie047', {
        feedback: text,
        timestamp: new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' })
      });
    }

    // Direkt senden (Haupt-Buttons)
    async function sendDirect(btn, msg) {
      const orig = btn.getAttribute('data-orig') || btn.innerHTML; // Emojis sind Klartext
      setBtnState(btn, 'ğŸ“¨ Sendeâ€¦', true);
      try { await sendViaEmailJS(msg); setBtnState(btn, 'âœ… Danke fÃ¼r dein Feedback!', true); }
      catch(e) { setBtnState(btn, 'âŒ Fehler â€“ erneut versuchen?', false); return; }
      setTimeout(() => { btn.innerHTML = orig; btn.disabled = false; }, 1800);
    }

    // Modal Handling
    function openModal(msg, req = false) {
      currentMsg = msg; requireText = req;
      document.getElementById('modal-title').textContent = msg;
      document.getElementById('extra-text').value = '';
      document.getElementById('no-text-btn').style.display = req ? 'none' : 'block';
      document.getElementById('modal').style.display = 'block';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function sendWithText(btnEl) {
      const txt = document.getElementById('extra-text').value.trim();
      if (requireText && !txt) { alert('Text erforderlich!'); return; }
      const full = currentMsg + (txt ? ' â€“ ' + txt : '');
      const orig = btnEl.innerHTML;
      setBtnState(btnEl, 'ğŸ“¨ Sendeâ€¦', true);
      try { await sendViaEmailJS(full); setBtnState(btnEl, 'âœ… Danke fÃ¼r dein Feedback!', true); setTimeout(() => { closeModal(); btnEl.innerHTML = orig; btnEl.disabled = false; }, 900); }
      catch(e) { setBtnState(btnEl, 'âŒ Fehler â€“ erneut?', false); }
    }

    async function sendWithoutText(btnEl) {
      const orig = btnEl.innerHTML;
      setBtnState(btnEl, 'ğŸ“¨ Sendeâ€¦', true);
      try { await sendViaEmailJS(currentMsg); setBtnState(btnEl, 'âœ… Danke fÃ¼r dein Feedback!', true); setTimeout(() => { closeModal(); btnEl.innerHTML = orig; btnEl.disabled = false; }, 900); }
      catch(e) { setBtnState(btnEl, 'âŒ Fehler â€“ erneut?', false); }
    }

    // Init / Polling
    loadStatus();
    setInterval(loadStatus, 20000);
  </script>
</body>
</html>
