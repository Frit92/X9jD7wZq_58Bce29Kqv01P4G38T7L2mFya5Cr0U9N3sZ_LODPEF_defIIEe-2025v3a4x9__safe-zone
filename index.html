<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Fritflix Feedback</title>
  <style>
    :root {
      --primary: #e50914;
      --primary-hover: #f41a22;
      --secondary: #333;
      --text: #fff;
      --bg: #111;
      --box-bg: #1b1b1b;
      --border: #444;
      --success: #28a745;
      --error: #dc3545;
      --blue: #1a73e8;
      --row-alt: #191919;
      --row-alt2: #212121;
      --badge: #ffcc00;
      --faq-green: #2e7d32;
      --faq-green-hover: #388e3c;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1em;
      text-align: center;
      min-height: 100vh;
      margin: 0;
      gap: 1em;
    }
    h1 { font-size: 1.8em; margin: 0.5em 0 0.2em; font-weight: 600; }

    /* Banner */
    #switch-banner {
      position: sticky;
      top: 0;
      z-index: 999;
      width: 95%;
      max-width: 420px;
      display: none;
      border-radius: 10px;
      padding: 0.6em 0.8em;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      font-weight: 800;
      letter-spacing: 0.3px;
      border: 1px solid #00000040;
    }
    #switch-banner .icon { font-size: 1.25em; margin-right: 0.4em; }
    #switch-banner.switching { background: linear-gradient(90deg, var(--badge), #ffaa00); color: #111; }
    #switch-banner.offline { background: linear-gradient(90deg, #ff5555, #ff2222); color: #fff; border-color: #00000070; }

    /* Status */
    details#status-details {
      width: 95%;
      max-width: 420px;
      background: var(--box-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    details#status-details > summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.6em;
      padding: 0.9em 1em;
      cursor: pointer;
      user-select: none;
      background: #202020;
    }
    details#status-details > summary::-webkit-details-marker { display: none; }
    .chev { transition: transform .2s ease; }
    details[open] .chev { transform: rotate(90deg); }
    .summary-row { display: flex; align-items: center; gap: 0.6em; width: 100%; justify-content: space-between; }
    .summary-left { display: flex; align-items: center; gap: 0.6em; font-weight: 600; }
    .summary-meta { font-size: .85em; opacity: .8; }
    .summary-bars { display: grid; grid-template-columns: 1fr; gap: 4px; width: 48%; }
    .mini-bar { height: 8px; background: #333; border-radius: 6px; overflow: hidden; }
    .mini-bar > span { display: block; height: 100%; background: var(--primary); }
    .mini-bar.blue > span { background: var(--blue); }
    #status-box {
      padding: 1.0em 1em 1.2em;
      text-align: left;
      font-size: 0.98em;
      line-height: 1.6;
      border-top: 1px solid var(--border);
      background: var(--box-bg);
    }
    progress {
      width: 100%; height: 16px; margin: 0.4em 0; border-radius: 10px; overflow: hidden;
    }
    progress::-webkit-progress-bar { background: #333; border-radius: 10px; }
    progress::-webkit-progress-value { background: var(--primary); border-radius: 10px; }
    progress.high::-webkit-progress-value { background: var(--error); }
    progress.blue::-webkit-progress-value { background: var(--blue); }

    .button-container {
      display: flex; flex-direction: column; gap: 0.7em; width: 95%; max-width: 420px;
    }
    .btn-row {
      display: flex; gap: 0.5em; width: 100%; padding: 0.25em; border-radius: 10px;
    }
    .btn-row:nth-child(odd) { background: var(--row-alt); }
    .btn-row:nth-child(even) { background: var(--row-alt2); }
    button {
      border: none; border-radius: 0.6em; cursor: pointer; transition: all 0.2s ease;
      font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.55em;
    }
    .feedback-btn {
      flex: 1; background: var(--primary); color: #fff; font-size: 1.05em;
      padding: 0.95em 0.8em; min-height: 54px;
    }
    .feedback-btn:hover { background: var(--primary-hover); }
    .feedback-btn:disabled { background: #666; cursor: not-allowed; }
    .note-btn {
      background: var(--secondary); color: #fff; font-size: 1.25em;
      width: 54px; min-height: 54px; padding: 0; display: flex; align-items: center; justify-content: center;
    }
    .note-btn:hover { background: #444; }

    .speedtest-btn, .faq-jump-btn {
      background: var(--blue); color: #fff; font-weight: 700;
      margin: 0.2em 0 0.8em; padding: 1.0em; font-size: 1.05em;
      border-radius: 0.6em; width: 95%; max-width: 420px;
    }
    .speedtest-btn:hover { background: #0d62c7; }
    .faq-jump-btn { background: var(--faq-green); margin: 0.8em 0 0.2em; }
    .faq-jump-btn:hover { background: var(--faq-green-hover); }

    .speedtest-btn.loading { background: #666; }
    .speedtest-btn.success { background: var(--success); }
    .speedtest-btn.error { background: var(--error); }

    /* Push-Button â€“ andere Farbe (z. B. Lila/Violett) */
#push-btn {
  background: #6a1b9a;          /* dunkles Lila */
  color: white;
}

#push-btn:hover {
  background: #7e57c2;          /* heller beim Hover */
}

#push-btn.success {
  background: #2e7d32;          /* grÃ¼n bei Erfolg */
}

#push-btn.error {
  background: #d32f2f;          /* rot bei Fehler */
}

#push-btn.loading {
  background: #555;
}

/* Kleiner Status-Text im Button */
.push-status-inline {
  font-size: 0.82em;
  opacity: 0.85;
  display: block;
  margin-top: 0.25em;
  font-weight: normal;
}

.push-status-inline strong {
  font-weight: 600;
}

.push-status-inline:has(âœ“) {
  color: #66bb6a;   /* hellgrÃ¼n */
}

    #modal {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #333; padding: 1.0em 1.0em 1.2em; border-radius: 0.8em;
      width: 88%; max-width: 420px; z-index: 100; border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #modal h3 { margin: 0 0 0.7em; font-size: 1.2em; }
    #modal textarea {
      width: 100%; height: 110px; background: #444; color: #fff;
      border: 1px solid #666; border-radius: 0.5em; padding: 0.6em;
      font-size: 0.98em; resize: none;
    }
    #modal .modal-buttons { display: flex; flex-direction: column; gap: 0.8em; margin-top: 0.8em; }
    #modal .primary-full { width: 100%; }
    #modal .bottom-row { display: flex; gap: 0.6em; }
    #modal .bottom-row > button { flex: 1; }
    .subtle-btn { background: #2a2a2a; color: #dddddd; border: 1px solid #444; }
    .subtle-btn:hover { background: #353535; color: #ffffff; }

/* === FAQ SECTION === */
#faq-section {
  width: 95%;
  max-width: 420px;
  background: var(--box-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 0.8em 1em;
  margin-top: 0.5em;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  text-align: left;            /* NEU: Alles in der FAQ linksbÃ¼ndig */
}

#faq-search {
  width: 100%;
  padding: 0.7em;
  background: #333;
  color: #fff;
  border: 1px solid #555;
  border-radius: 0.6em;
  margin-bottom: 0.8em;
  font-size: 0.95em;
}

.faq-item {
  margin-bottom: 0.6em;
}

.faq-item > summary {
  list-style: none;
  cursor: pointer;
  font-weight: 700;            /* leicht verstÃ¤rkt: Frage fett(er) */
  font-size: 1.02em;
  padding: 0.75em 0;
  display: flex;
  align-items: center;
  gap: 0.5em;
  border-bottom: 1px solid #333;
}

.faq-item > summary::-webkit-details-marker { 
  display: none; 
}

.faq-item[open] > summary { 
  border-bottom: none; 
  padding-bottom: 0.5em; 
}

.faq-item[open] > summary .chev { 
  transform: rotate(90deg); 
}

.faq-answer {
  font-size: 0.94em;
  line-height: 1.55;
  padding: 8px 0 12px 24px;
  border-bottom: 1px solid #333;
  text-align: left;            /* explizit: Antworten auch links */
}

.faq-answer:last-child { 
  border-bottom: none; 
}

.faq-answer ol, .faq-answer ul { 
  margin: 0.4em 0; 
  padding-left: 1.4em; 
}

.faq-answer li { 
  margin-bottom: 0.3em; 
}

.faq-answer a { 
  color: var(--blue); 
  text-decoration: underline; 
}

    @media (max-width: 480px) {
      h1 { font-size: 1.5em; }
      .feedback-btn { font-size: 1em; padding: 0.9em 0.7em; min-height: 50px; }
      .note-btn { font-size: 1.2em; width: 50px; min-height: 50px; }
      .summary-bars { width: 50%; }
    }

      /* Slider */
    #latest-slider {
      width: 95%; max-width: 420px; overflow: hidden; margin: 1em 0;
    }
.slider-container {
  display: flex;
  transition: transform 0.5s ease;
  gap: 0.8em;               /* Abstand zwischen Postern */
  padding: 0.4em 0.6em;
  scroll-snap-type: x mandatory;  /* FÃ¼r Wischen wichtig */
  overflow-x: auto;           /* ErmÃ¶glicht Scrollen/Wischen */
  -webkit-overflow-scrolling: touch;  /* Smooth Scroll auf iOS */
}

.slider-item {
  flex: 0 0 110px;
  width: 110px;
  background: #1a1a1a;
  border-radius: 10px;
  padding: 0.4em;
  text-align: center;
  box-shadow: 0 3px 10px rgba(0,0,0,0.5);
  cursor: pointer;
  transition: transform 0.18s ease;
}

.slider-item:hover {
  transform: scale(1.06);
}

.slider-item img {
  width: 100%;
  aspect-ratio: 2 / 3;
  object-fit: cover;
  border-radius: 8px;
  background: #111;
}

.slider-item h4 {
  font-size: 0.78em;
  margin: 0.5em 0 0.2em;
  line-height: 1.15;
  height: 2.4em;
  overflow: hidden;
  text-overflow: ellipsis;
}

.slider-item .season-info {
  font-size: 0.68em;
  color: #aaa;
  margin-top: 2px;
}

.slider-item p {
  font-size: 0.7em;
  opacity: 0.9;
  margin: 0.15em 0;
  line-height: 1.2;
}

/* Detail Modal */
#detailModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.88);
  z-index: 9999;
  justify-content: center;
  align-items: flex-start;
  overflow-y: auto;
  padding: 20px 10px;
}

.detail-content {
  background: #1f1f1f;
  border-radius: 12px;
  max-width: 720px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 10px 40px rgba(0,0,0,0.7);
  padding: 24px;
}

.close-detail {
  position: sticky;
  top: 12px;
  margin-left: auto;
  background: #e50914;
  color: white;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-size: 22px;
  cursor: pointer;
  z-index: 20;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.6);
}


.close-detail:hover {
  background: #f41a22;
}

.detail-poster {
  max-width: 100%;
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.6);
}

.detail-header { margin: 0 0 12px; font-size: 1.6em; }

.detail-meta {
  color: #aaa;
  font-size: 0.95em;
  margin: 8px 0;
}

.detail-overview {
  margin: 16px 0;
  line-height: 1.5;
  color: #ddd;
}

.detail-actions {
  margin: 20px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.detail-btn {
  padding: 10px 18px;
  border-radius: 6px;
  font-weight: bold;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.detail-btn.trailer {
  background: #6528b5;
  color: white;
}

.detail-btn.imdb {
  background: #f5c518;
  color: black;
}

.detail-btn.rt {
  background: #388e3c;
  color: white;
}

.detail-btn.rt.rotten {
  background: #d32f2f;
}

.detail-layout {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
}
    
/* Handy: Poster oben, Text unten */
@media (max-width: 600px) {
  .detail-layout {
    flex-direction: column;
  }
  .detail-poster {
    max-width: 240px;
    margin: 0 auto 16px;
  }
}
  /* kleine Zeilen unter "Film â€¢ QualitÃ¤t" */
.detail-audio,
.detail-subs{
  margin-top: 4px;
  font-size: 0.85em;
  opacity: 0.9;
  line-height: 1.25;
  color: #ddd;
}

/* forced klein & unauffÃ¤llig */
.detail-subs-forced{
  margin-left: 6px;
  font-size: 0.9em;
  opacity: 0.7;
}

/* Buttons die keine Links sind */
.detail-btn.static{
  cursor: default;
}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e50914">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Fritflix Feedback">
<script>
const VERSION = 'v1.4.8';

window.addEventListener('DOMContentLoaded', () => {
  if (!('serviceWorker' in navigator)) {
    // Kein Service Worker â†’ Push-UI trotzdem initial setzen
    if (typeof refreshPushUI === 'function') refreshPushUI();
    return;
  }

  let newWorker;
  const updateBanner = document.getElementById('update-banner');
  const reloadBtn = document.getElementById('update-reload-btn');

  function showUpdateBanner() {
    if (!updateBanner || !reloadBtn) return;
    updateBanner.style.display = 'block';
    reloadBtn.onclick = () => {
      if (newWorker) {
        newWorker.postMessage({ type: 'SKIP_WAITING' });
      }
    };
  }

  navigator.serviceWorker
    .register('sw.js?v=' + VERSION)
    .then(async (reg) => {
      console.log('SW registriert:', reg.scope);

      // ğŸ”” Push-UI IMMER nach erfolgreicher Registrierung synchronisieren
      if (typeof refreshPushUI === 'function') {
        await refreshPushUI();
      }

      // Bereits wartender Worker
      if (reg.waiting) {
        newWorker = reg.waiting;
        showUpdateBanner();
      }

      // Neuer Worker im Installationsprozess
      reg.addEventListener('updatefound', () => {
        newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (
            newWorker.state === 'installed' &&
            navigator.serviceWorker.controller
          ) {
            showUpdateBanner();
          }
        });
      });
    })
    .catch(err => {
      console.error('SW Registrierung fehlgeschlagen:', err);
      // Auch hier: Push-UI wenigstens korrekt setzen
      if (typeof refreshPushUI === 'function') refreshPushUI();
    });

  // Nach skipWaiting â†’ Seite sauber neu laden
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
});
</script>
</head>
<body>
  <h1>Feedback zu Fritflix</h1>

  <!-- Banner -->
  <div id="switch-banner">
    <span class="icon">Warnung</span>
    <span id="switch-text">INTERNETSTÃ–RUNG â€“ Bitte in 5min erneut probierenâ€¦</span>
  </div>

  <!-- Status -->
  <details id="status-details">
    <summary>
      <div class="summary-row">
        <div class="summary-left">
          <span class="chev">â–¶</span>
          <span id="summary-server">Server: â€“</span>
        </div>
        <div class="summary-bars">
          <div class="mini-bar" title="Auslastung"><span id="mini-load" style="width:0%"></span></div>
          <div class="mini-bar blue" title="DL"><span id="mini-dl" style="width:0%"></span></div>
          <div class="mini-bar blue" title="UL"><span id="mini-ul" style="width:0%"></span></div>
        </div>
      </div>
      <div class="summary-meta" id="summary-meta"></div>
    </summary>
    <div id="status-box">Lade Server-Statusâ€¦</div>
  </details>

  <!-- Push Button -->
  <button id="push-btn" class="speedtest-btn">
  ğŸ”” Push aktivieren
  <span id="push-status-inline" class="push-status-inline">prÃ¼fe Status...</span>
</button>
  
  <!-- Speedtest Button -->
  <button id="speedtest-btn" class="speedtest-btn" onclick="runSpeedtest()">â±ï¸ Speedtest (Server) starten</button>
<button id="client-speedtest-btn"
        class="speedtest-btn"
        style="margin-top:-1.2em; opacity:0.95;"
        onclick="runClientSpeedtest()">
  ğŸ“¶ Eigener Speedtest (deine Leitung)
</button>

<div id="client-speedtest-result"
     style="margin:0.4em auto 0.8em; max-width:420px; width:95%; font-size:0.9em; text-align:left; opacity:0.9;">
  Noch kein Test ausgefÃ¼hrt.
</div>

<div id="latest-slider">
    <h2>Neueste Filme & Serien</h2>
    <div class="slider-container" id="slider-container"></div>
</div>

  <!-- FAQ Button (unter Speedtest, grÃ¼n) -->
  <button class="faq-jump-btn" onclick="document.getElementById('faq-section').scrollIntoView({behavior:'smooth'})">
    FAQ â€“ HÃ¤ufige Fragen
  </button>

  <!-- Feedback Buttons -->
  <div class="button-container">
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â›” Server offline" onclick="sendDirect(this, 'â›” Server offline')">â›” Server offline</button>
      <button class="note-btn" onclick="openModal('Server offline')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ” Anmeldung nicht mÃ¶glich" onclick="sendDirect(this, 'ğŸ” Anmeldung nicht mÃ¶glich')">ğŸ” Anmeldung nicht mÃ¶glich</button>
      <button class="note-btn" onclick="openModal('Anmeldung nicht mÃ¶glich')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â¹ï¸ Stream startet nicht" onclick="sendDirect(this, 'â¹ï¸ Stream startet nicht')">â¹ï¸ Stream startet nicht</button>
      <button class="note-btn" onclick="openModal('Stream startet nicht')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸŒ Stream ruckelt" onclick="sendDirect(this, 'ğŸŒ Stream ruckelt')">ğŸŒ Stream ruckelt</button>
      <button class="note-btn" onclick="openModal('Stream ruckelt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â¸ï¸ Stream stoppt an bestimmter Stelle" onclick="sendDirect(this, 'â¸ï¸ Stream stoppt an bestimmter Stelle')">â¸ï¸ Stream stoppt an bestimmter Stelle</button>
      <button class="note-btn" onclick="openModal('Stream stoppt an bestimmter Stelle')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”‡ Kein Ton vorhanden" onclick="sendDirect(this, 'ğŸ”‡ Kein Ton vorhanden')">ğŸ”‡ Kein Ton vorhanden</button>
      <button class="note-btn" onclick="openModal('Kein Ton vorhanden')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ“ºâœ–ï¸ğŸ”Š Ton und Bild nicht synchron" onclick="sendDirect(this, 'ğŸ“ºâœ–ï¸ğŸ”Š Ton und Bild nicht synchron')">ğŸ“ºâœ–ï¸ğŸ”Š Ton und Bild nicht synchron</button>
      <button class="note-btn" onclick="openModal('Ton und Bild nicht synchron')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”ˆâœ–ï¸ Originaltonspur fehlt" onclick="sendDirect(this, 'ğŸ”ˆâœ–ï¸ Originaltonspur fehlt')">ğŸ”ˆâœ–ï¸ Originaltonspur fehlt</button>
      <button class="note-btn" onclick="openModal('Originaltonspur fehlt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ“ƒâœ–ï¸ Untertitel fehlen" onclick="sendDirect(this, 'ğŸ“ƒâœ–ï¸ Untertitel fehlen')">ğŸ“ƒâœ–ï¸ Untertitel fehlen</button>
      <button class="note-btn" onclick="openModal('Untertitel fehlen')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="â³ Untertitel nicht synchron" onclick="sendDirect(this, 'â³ Untertitel nicht synchron')">â³ Untertitel nicht synchron</button>
      <button class="note-btn" onclick="openModal('Untertitel nicht synchron')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ‘¾ BildqualitÃ¤t schlecht (kein HD)" onclick="sendDirect(this, 'ğŸ‘¾ BildqualitÃ¤t schlecht (kein HD)')">ğŸ‘¾ BildqualitÃ¤t schlecht (kein HD)</button>
      <button class="note-btn" onclick="openModal('BildqualitÃ¤t schlecht (kein HD)')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ”€ Falscher Film/Serie wird abgespielt" onclick="sendDirect(this, 'ğŸ”€ Falscher Film/Serie wird abgespielt')">ğŸ”€ Falscher Film/Serie wird abgespielt</button>
      <button class="note-btn" onclick="openModal('Falscher Film/Serie wird abgespielt')">ğŸ“</button>
    </div>
    <div class="btn-row">
      <button class="feedback-btn" data-orig="ğŸ’¥ App stÃ¼rzt ab" onclick="sendDirect(this, 'ğŸ’¥ App stÃ¼rzt ab')">ğŸ’¥ App stÃ¼rzt ab</button>
      <button class="note-btn" onclick="openModal('App stÃ¼rzt ab')">ğŸ“</button>
    </div>
  </div>

  <button class="feedback-btn" style="margin-top:0.6em;padding:1em;width:95%;max-width:420px;" onclick="openModal('â• Anderes Problem', true)">â• Anderes Problem</button>

  <!-- FAQ Section (aufklappbar!) -->
  <section id="faq-section">
    <input type="text" id="faq-search" placeholder="FAQ durchsuchenâ€¦" onkeyup="filterFAQ()">

    <!-- FAQ: Die wichtigsten Anforderungen -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> ğŸ“‹ Die wichtigsten Anforderungen fÃ¼r flÃ¼ssiges Streaming</summary>
  <div class="faq-answer">
    â€¢ <b>Download bei dir:</b> mind. 30 Mbit/s stabil<br>
    â€¢ <b>Upload (Server-Seite):</b> Ã¼ber 20 Mbit/s<br>
    â€¢ <b>Latenz (Ping) bei dir und Server:</b> unter 50 ms<br>
    â€¢ <b>Bitrate im Player:</b> 3â€“10 Mbit/s (bei 4K meist ca. 10 Mbit/s)<br>
    â€¢ <b>Verbindung:</b> stabiles WLAN (besser 5 GHz) oder LAN-Kabel<br><br>
    ğŸ”½ Wenn etwas davon nicht passt â†’ Ruckeln/AbbrÃ¼che mÃ¶glich
  </div>
</details>

<!-- FAQ: Ruckeln -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> ğŸ¬ Der Film oder die Serie ruckelt â€“ was tun?</summary>
  <div class="faq-answer">
    1. <b>QualitÃ¤t prÃ¼fen:</b> LÃ¤uft Direct Play? QualitÃ¤t auf Auto oder mind. 20 Mbit/s?<br>
    â†’ Ruckelt es trotzdem â†’ Bitrate schrittweise senken (8 â†’ 5 â†’ 3 Mbit/s).<br>
    <b>Tipp bei 4K:</b> Oft erst bei ca. 10 Mbit/s flÃ¼ssig.<br><br>

    2. <b>Server-Auslastung prÃ¼fen:</b> Oben auf der Seite siehst du aktive Streams.<br>
    â†’ Ab 3â€“4 gleichzeitigen Nutzern kann es eng werden.<br><br>

    3. <b>Server-Speedtest starten:</b> Button oben klicken.<br>
    â†’ Upload unter 20 Mbit/s? â†’ Admin informieren oder zur vollen Stunde warten (automatischer Serverwechsel).<br><br>

    4. <b>Eigener Speedtest:</b> Button â€Eigener Speedtestâ€œ oder Google Speedtest.<br>
    â†’ Unter 30 Mbit/s Download oder Ã¼ber 50 ms Latenz = dein Anschluss ist das Problem.<br><br>

    5. <b>10 Minuten warten</b> â€“ kurzzeitige Schwankungen sind normal.<br><br>
    
    6. <b>App neu starten.</b><br>
    â¤ Immer noch Probleme? â†’ Admin kontaktieren.
  </div>
</details>

<!-- FAQ: HÃ¤ufige AbbrÃ¼che -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> âš¡ Ich habe hÃ¤ufig AbbrÃ¼che â€“ was hilft?</summary>
  <div class="faq-answer">
    1. WLAN optimieren (nÃ¤her am Router, 5 GHz, weniger WÃ¤nde)<br>
    2. GerÃ¤t per LAN-Kabel anstatt WLAN nutzen<br>
    3. Bitrate des Films reduzieren<br>
    4. Fire TV / Android TV / modernes Handy statt altem GerÃ¤t oder Browser nutzen<br>
    5. Server-Auslastung & Speedtests prÃ¼fen<br>
    6. App statt Browser verwenden â†’ immer stabiler
  </div>
</details>

<!-- FAQ: Anmeldung Probleme -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> ğŸ” Ich kann mich nicht anmelden (evtl. Fehler "keine Berechtigung um auf den Server zuzugreifen")</summary>
  <div class="faq-answer">
    1. <b>Passwort korrekt?</b> GroÃŸ-/Kleinschreibung beachten.<br>
    2. <b>Noch auf einem anderen GerÃ¤t eingeloggt?</b> â†’ Dort abmelden (nur 1 GerÃ¤t gleichzeitig ist erlaubt).<br>
    3. <b>Profilbild grau?</b> Konto ist gesperrt â†’ Admin informieren.<br>
    4. Immer noch nicht? â†’ Admin melden.
  </div>
</details>

<!-- FAQ: Wie anmelden -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> ğŸšª Wie melde ich mich an?</summary>
  <div class="faq-answer">
    1. Jellyfin-/Swiftfin-App installieren oder Browser Ã¶ffnen<br>
    2. Server-Adresse eingeben:<br>
    â†’ Browser & die meisten Apps: <b>https://fritflix.cc</b><br>
    â†’ iPhone/iPad/Apple TV (Swiftfin): <b>https://app.fritflix.cc</b><br>
    3. <b>Nur im Browser:</b> â€Generalbenutzerâ€œ + Passwort aus der WhatsApp-Gruppenbeschreibung eingeben<br>
    4. Dein Profil auswÃ¤hlen â†’ privates Passwort eingeben<br>
    5. Losstreamen!
  </div>
</details>

<!-- FAQ: Film nicht gefunden -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> ğŸ” Ich finde einen Film/Serie nicht</summary>
  <div class="faq-answer">
    1. Keine Leerzeichen vorne/hinten im Suchfeld<br>
    2. Nur Deutsche & Originaltitel werden erkannt<br>
    3. Umlaute wie Ã¤, Ã¶ oder Ã¼ sind manchmal problematisch â†’ anderes Wort aus dem Titel oder Originaltitel probieren<br>
    4. Nicht vorhanden? â†’ Wunsch an Admin schicken
  </div>
</details>

<!-- FAQ: Film startet nicht -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> â³ Der Film startet nicht / lÃ¤dt ewig</summary>
  <div class="faq-answer">
    1. <b>Geduld:</b> 4K-Filme brauchen manchmal bis zu 5 Minuten Vorlauf<br>
    2. Jellyfin-App neu starten<br>
    3. Server-Speedtest & Auslastung prÃ¼fen<br>
    4. Eigenen Speedtest machen
  </div>
</details>

<!-- FAQ: Nicht kompatibel -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Fehlermeldung: â€Nicht kompatibel mit Client/AbspielgerÃ¤tâ€œ</summary>
  <div class="faq-answer">
    Der Film at zu lange geladen udn Jellyfin hat abgebrochen.<br>
    â¤ Bitrate senken + neu laden<br>
    â¤ Eigenen Speed und Latenz checken mit Speedtest<br>
    â¤ Anderes GerÃ¤t testen
  </div>
</details>

<!-- FAQ: Kann nicht wiedergegeben werden -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Fehlermeldung: â€Kann nicht wiedergegeben werdenâ€œ</summary>
  <div class="faq-answer">
    Externe Festplatte wurde nicht erkannt â†’ Datei ist fÃ¼r Jellyfin â€verschwundenâ€œ.<br>
    â¤ Admin informieren
  </div>
</details>

<!-- FAQ: Server offline -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Server ist offline</summary>
  <div class="faq-answer">
    1. VPN komplett ausschalten oder anderes Land wÃ¤hlen (nur DE & ES erlaubt)<br>
    2. Eigene Internetverbindung prÃ¼fen (Speedtest, andere Webseiten testen)<br>
    3. Wenn der Server lÃ¤nger als 10â€“15 Minuten nicht erreichbar ist â†’ <b>Admin melden</b><br>
    <small>Hinweis: Jetzt lÃ¤uft alles Ã¼ber einen Hetzner-Server + Heimserver. Ist einer von beiden gestÃ¶rt, kann Fritflix kurz offline sein.</small>
  </div>
</details>

<!-- FAQ: Intro Ã¼berspringen -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Intro lÃ¤sst sich nicht Ã¼berspringen</summary>
  <div class="faq-answer">
    â€¢ Button â€Intro Ã¼berspringenâ€œ erscheint automatisch (Android TV: Kreis mit Text)<br>
    â€¢ Wird automatisch generiert â†’ nicht immer 100 % perfekt<br>
    â†’ Notfalls manuell vorspulen
  </div>
</details>

<!-- FAQ: Falsche Sprache -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Falsche Sprache wird abgespielt</summary>
  <div class="faq-answer">
    1. Ãœber Noten-/Zahnrad-Symbol Tonspur wechseln<br>
    2. Andere Tonspur ausprobieren (manchmal falsch benannt)<br>
    3. Hilft nicht)? â†’ Bitrate auf 5 Mbit/s senken und Punkt 1 & 2 nochmal probieren<br>
    4. Immer noch falsch â†’ Admin melden
  </div>
</details>

<!-- FAQ: Ton asynchron -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Ton ist asynchron</summary>
  <div class="faq-answer">
    â€¢ Im Browser passiert das manchmal â†’ lieber die App nutzen<br>
    â€¢ Auch in der App asynchron? â†’ Admin melden
  </div>
</details>

<!-- FAQ: Untertitel Probleme -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Untertitel fehlen oder werden trotz â€Ausâ€œ angezeigt</summary>
  <div class="faq-answer">
    â€¢ 1â€“2 Minuten warten (laden der Untertitel dauert ein bisschen)<br>
    â€¢ Richtig gewÃ¤hlt?: Forced = nur nicht Ã¼bersetzte Teile, Full = komplett<br>
    â€¢ Manche Filme haben eingebrannte Untertitel. Die sind direkt in der Vidodatei & nicht abschaltbar<br>
    â€¢ Bug nach mehrfachen Umschalten â†’ Film einfach neu starten<br>
    â€¢ Immer noch falsch/fehlend â†’ Admin melden
  </div>
</details>

<!-- FAQ: Apps -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Wo finde ich die richtigen Apps?</summary>
  <div class="faq-answer">
    In den App Stores:
    â€¢ Smart TV â†’ Jellyfin<br>
    â€¢ Android/iOS â†’ Jellyfin<br>
    â€¢ Fire TV Stick â†’ Jellyfin<br>
    â€¢ Magenta TV â†’ Jellyfin<br>
    â€¢ Apple TV â†’ Swiftfin<br>
    â€¢ PC â†’ Jellyfin Media Player <a href="https://github.com/jellyfin/jellyfin-media-player/releases/tag/v1.12.0" target="_blank">Download (richtige Version wÃ¤hlen)</a>
  </div>
</details>

<!-- FAQ: Browser Bug Generalnutzer -->
<details class="faq-item">
  <summary><span class="chev">â–¶</span> Im Browser kommt immer wieder Generalnutzer-Anmeldemaske</summary>
  <div class="faq-answer">
    Bekannter Bug nach Updates.<br>
    â¤ Admin informieren â€“ wird in 2 Minuten gefixt
  </div>
</details>

  <!-- Modal -->
  <div id="modal">
    <h3 id="modal-title"></h3>
    <textarea id="extra-text" placeholder="ZusÃ¤tzliche Beschreibungâ€¦"></textarea>
    <div class="modal-buttons">
      <button id="btn-with-text" class="feedback-btn primary-full" onclick="sendWithText(this)">ğŸ“¨ Senden mit Text</button>
      <div class="bottom-row">
        <button id="no-text-btn" class="subtle-btn" onclick="sendWithoutText(this)">ğŸ“¨ Ohne Text senden</button>
        <button class="feedback-btn" style="background:#666;" onclick="closeModal()">Abbrechen</button>
      </div>
    </div>
  </div>

  <script>
    emailjs.init({ publicKey: "E4jHB9-hSCQJ6yEUf" });
    const API_BASE = "https://fritflix.cc/api";
    const SPEEDTEST_TOKEN = "fhe9wzr83ezrw7ft72636770pueu9uft";
    const APP_TOKEN = "HHUEZ3dkrrzfg6wrÂ§1jdkfgfbW2974t52";
    const OFFLINE_THRESHOLD_MS = 15 * 60 * 1000;
    const FETCH_TIMEOUT_MS = 10000;
    const FETCH_TIMEOUT_MS_SPEEDTEST = 120000;
    const SPEEDTEST_POLL_TIMEOUT_MS = 90000;
    const SPEEDTEST_POLL_INTERVAL_MS = 2000;
    const FETCH_TIMEOUT_MS_STATUS = 10000;
    const MAX_MEMORY_AGE_MS = 24 * 60 * 60 * 1000;
    const LS_LAST_SUCCESS = 'ff_last_success_ts';
    const LS_FAIL_SINCE = 'ff_fail_since_ts';

    function lsNum(key) {
      const v = localStorage.getItem(key);
      const n = v == null ? null : Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function probeLocation(timeoutMs = 5000) {
      try {
        const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(timeoutMs) });
        if (!res.ok) return null;
        const data = await res.json();
        const country = data.country_code || 'Unbekannt';
        const isAllowed = ['DE', 'ES'].includes(country);
        const isVPN = data.org?.toLowerCase().includes('vpn') || data.hosting || false;
        return { city: data.city || 'Unbekannt', country, allowed: isAllowed, vpn: isVPN };
      } catch { return null; }
    }

    async function probeInternetOK(timeoutMs = 4000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        await fetch('https://www.gstatic.com/generate_204', { mode: 'no-cors', signal: ctrl.signal });
        clearTimeout(t);
        return true;
      } catch {
        clearTimeout(t);
        return false;
      }
    }

    let currentMsg = '', requireText = false;
    let lastSuccessTs = null;
    let failSinceTs = null;

    (function initPersistedState() {
      const persistedFail = lsNum(LS_FAIL_SINCE);
      const persistedOk = lsNum(LS_LAST_SUCCESS);
      if (persistedFail && (Date.now() - persistedFail) <= MAX_MEMORY_AGE_MS) {
        failSinceTs = persistedFail;
      } else {
        localStorage.removeItem(LS_FAIL_SINCE);
      }
      if (persistedOk) lastSuccessTs = persistedOk;
    })();

    function fetchWithTimeout(url, opts = {}, ms = FETCH_TIMEOUT_MS) {
      return Promise.race([
        fetch(url, opts),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), ms))
      ]);
    }
  function apiFetch(path, opts = {}, timeoutMs = FETCH_TIMEOUT_MS) {
  const headers = {
    ...(opts.headers || {}),
    "X-App-Token": APP_TOKEN,
    "Accept": "application/json",
  };

  return fetchWithTimeout(`${API_BASE}${path}`, { ...opts, headers }, timeoutMs);
}

// ===================
// PUSH UI + LOGIC
// ===================

const VAPID_PUBLIC_KEY = "BBpyaui5X3zV01eaVjY3lwRZReD9VoNo7gR4fqrkZ--DckIA7bxfbcwjrAxPTYZQZ9Jf5zu7uyUPJyADedKL1QQ";
const PUSH_STATUS_EL = () => document.getElementById('push-status');

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const output = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; i++) output[i] = rawData.charCodeAt(i);
  return output;
}

async function getSWRegistration() {
  if (!('serviceWorker' in navigator)) throw new Error('Service Worker nicht verfÃ¼gbar');

  // Wichtig: wartet zuverlÃ¤ssig, bis ein SW wirklich aktiv ist
  const reg = await navigator.serviceWorker.ready;
  if (!reg) throw new Error('Service Worker nicht bereit (neu laden)');
  return reg;
}

async function refreshPushUI() {
  const btn = document.getElementById('push-btn');
  if (!btn) return;

  try {
    const supported =
      'Notification' in window &&
      'PushManager' in window &&
      'serviceWorker' in navigator;

    if (!supported) {
      btn.disabled = true;
      btn.innerHTML = 'ğŸ”” Push nicht unterstÃ¼tzt';
      return;
    }

    const perm = Notification.permission;

    if (perm !== 'granted') {
      btn.disabled = false;
      btn.classList.remove('success', 'error', 'loading');
      btn.innerHTML = `ğŸ”” Push aktivieren<br><span class="push-status-inline">nicht aktiviert</span>`;
      btn.onclick = enablePush;
      return;
    }

    const reg = await getSWRegistration();
    const sub = await reg.pushManager.getSubscription();

    if (sub) {
      btn.disabled = false;
      btn.classList.remove('error', 'loading');
      btn.classList.add('success');
      btn.innerHTML = `ğŸ”” Push deaktivieren<br><span class="push-status-inline"><strong>aktiviert âœ“</strong></span>`;
      btn.onclick = disablePush;
    } else {
      btn.disabled = false;
      btn.classList.remove('success', 'error', 'loading');
      btn.innerHTML = `ğŸ”” Push aktivieren<br><span class="push-status-inline">nicht abonniert</span>`;
      btn.onclick = enablePush;
    }
  } catch (err) {
    console.warn('Push-Status Fehler:', err);
    btn.disabled = false;
    btn.classList.remove('success', 'loading');
    btn.classList.add('error');
    btn.innerHTML = `ğŸ”” Push aktivieren<br><span class="push-status-inline">Statusfehler</span>`;
    btn.onclick = enablePush;
  }
}

async function enablePush() {
  const btn = document.getElementById('push-btn');
  if (!btn) return;

  btn.disabled = true;
  btn.classList.remove('success', 'error');
  btn.classList.add('loading');
  btn.innerHTML = `ğŸ”” Wird aktiviertâ€¦<br><span class="push-status-inline">bitte warten (max. 10s)</span>`;

  const hardTimeout = setTimeout(() => {
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.classList.add('error');
    btn.innerHTML = `ğŸ”” Push aktivieren<br><span class="push-status-inline">Timeout â€“ erneut versuchen</span>`;
    btn.onclick = enablePush;
  }, 10000);

  try {
    const perm = await Notification.requestPermission();
    if (perm !== 'granted') throw new Error('Benachrichtigungen nicht erlaubt');

    const reg = await getSWRegistration();

    const sub = await (await reg.pushManager.getSubscription()) ||
      await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
      });

    const res = await apiFetch('/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subscription: sub }),
    }, 10000);

    if (!res.ok) throw new Error(`Backend Fehler: ${res.status}`);

    clearTimeout(hardTimeout);
    btn.classList.remove('loading');
    await refreshPushUI();
  } catch (err) {
    clearTimeout(hardTimeout);
    console.error('Push aktivieren Fehler:', err);
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.classList.add('error');
    btn.innerHTML = `ğŸ”” Push aktivieren<br><span class="push-status-inline">Fehler â€“ erneut versuchen</span>`;
    btn.onclick = enablePush;
  }
}

async function disablePush() {
  const btn = document.getElementById('push-btn');
  if (!btn) return;

  btn.disabled = true;
  btn.classList.remove('success', 'error');
  btn.classList.add('loading');
  btn.innerHTML = `ğŸ”” Wird deaktiviertâ€¦<br><span class="push-status-inline">bitte warten (max. 10s)</span>`;

  const hardTimeout = setTimeout(() => {
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.classList.add('error');
    btn.innerHTML = `ğŸ”” Push deaktivieren<br><span class="push-status-inline">Timeout â€“ erneut versuchen</span>`;
    btn.onclick = disablePush;
  }, 10000);

  try {
    const reg = await getSWRegistration();
    const sub = await reg.pushManager.getSubscription();

    if (sub) {
      await apiFetch('/push/unsubscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ endpoint: sub.endpoint }),
      }, 10000).catch(() => {});

      await sub.unsubscribe();
    }

    clearTimeout(hardTimeout);
    btn.classList.remove('loading');
    await refreshPushUI();
  } catch (err) {
    clearTimeout(hardTimeout);
    console.error('Push deaktivieren Fehler:', err);
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.classList.add('error');
    btn.innerHTML = `ğŸ”” Push deaktivieren<br><span class="push-status-inline">Fehler â€“ erneut versuchen</span>`;
    btn.onclick = disablePush;
  }
}
    
function setBanner(mode, extraText) {
  const banner = document.getElementById('switch-banner');
  const text = document.getElementById('switch-text');
  if (mode === 'hidden') {
    banner.style.display = 'none';
    banner.classList.remove('switching', 'offline');
    return;
  }
  banner.style.display = 'block';
  banner.classList.remove('switching', 'offline');
  if (mode === 'switching') {
    banner.classList.add('switching');
    text.textContent = extraText || 'Verbindungsproblem â€“ der Server antwortet gerade nichtâ€¦';
  } else if (mode === 'offline') {
    banner.classList.add('offline');
    text.textContent = extraText || 'Server nicht erreichbar. Bitte Admin kontaktieren.';
  }
}

    function setMiniBars(loadPct, dlPct, ulPct) {
      document.getElementById('mini-load').style.width = Math.min(loadPct, 100) + '%';
      document.getElementById('mini-dl').style.width = Math.min(dlPct, 100) + '%';
      document.getElementById('mini-ul').style.width = Math.min(ulPct, 100) + '%';
    }

    function setSummaryMeta(ts) {
      const el = document.getElementById('summary-meta');
      if (!ts) { el.textContent = ''; return; }
      const dt = new Date(ts);
      el.textContent = `Letzte Aktualisierung: ${dt.toLocaleTimeString('de-DE')}`;
    }

    async function loadStatus() {
      try {
        const res = await fetchWithTimeout(`${API_BASE}/status`);
        const data = await res.json();

        lastSuccessTs = Date.now();
        failSinceTs = null;
        localStorage.setItem(LS_LAST_SUCCESS, String(lastSuccessTs));
        localStorage.removeItem(LS_FAIL_SINCE);

        const vpn = data.vpn || {};
        const speed = vpn.last_speedtest || { ping: 0, download: 0, upload: 0 };

        const lastSpeedLabel =
          speed && (speed.time || speed.timestamp)
            ? (speed.time || speed.timestamp)
            : 'â€“';

        const dlPct = Math.min((speed.download / 90) * 100, 100);
        const ulPct = Math.min((speed.upload / 36) * 100, 100);
        const loadPct = Math.min(data.load_percent || 0, 100);

        const summaryEl = document.getElementById('summary-server');
        summaryEl.textContent = `Server: ${vpn.current_server || 'Fritflix'}`;

        // Banner ausblenden, wenn alles okay
        setBanner('hidden');
        setMiniBars(loadPct, dlPct, ulPct);
        setSummaryMeta(lastSuccessTs);

        document.getElementById('status-box').innerHTML = `
          <p><b>Server:</b> ${vpn.current_server || 'Fritflix'}</p>
          <p><b>Gesamt-Auslastung:</b> ${data.load_percent || 0}% (${data.streams || 0} Streams, ${data.downloads || 0} Downloads)</p>
          <progress value="${(data.load_percent || 0)/100}" max="1" class="${(data.load_percent || 0) > 75 ? 'high' : ''}"></progress>
          <p><b>Letzter Speedtest (Server):</b> ${lastSpeedLabel}</p>
          <p><b>Ping:</b> <b>${speed.ping || 0} ms</b></p>
          <p><b>DL:</b> <b>${speed.download || 0} Mbit/s</b></p>
          <progress value="${dlPct/100}" max="1" class="blue"></progress>
          <p><b>UL:</b> <b>${speed.upload || 0} Mbit/s</b></p>
          <progress value="${ulPct/100}" max="1" class="blue"></progress>
        `;

        // Buttontext im Normalfall (online)
        const speedBtn = document.getElementById('speedtest-btn');
        if (lastSpeedLabel !== 'â€“') {
          speedBtn.innerHTML = `â±ï¸ Speedtest (Server) starten<br><small>Letzter: ${lastSpeedLabel}</small>`;
        } else {
          speedBtn.innerHTML = 'â±ï¸ Speedtest (Server) starten';
        }

      } catch (e) {
        console.warn("Status nicht abrufbar:", e);

        if (!failSinceTs) {
          const persistedFail = lsNum(LS_FAIL_SINCE);
          if (persistedFail && (Date.now() - persistedFail) <= MAX_MEMORY_AGE_MS) {
            failSinceTs = persistedFail;
          } else {
            failSinceTs = Date.now();
          }
        }
        localStorage.setItem(LS_FAIL_SINCE, String(failSinceTs));

        const lastSuccessPersisted = lsNum(LS_LAST_SUCCESS);
        setSummaryMeta(lastSuccessPersisted || lastSuccessTs);
        document.getElementById('summary-server').textContent = 'Server: (unbekannt)';

        const elapsed = Date.now() - failSinceTs;
        const isOffline = elapsed >= OFFLINE_THRESHOLD_MS;
        if (isOffline) {
          setBanner('offline', 'Server offline â€“ bitte Administrator kontaktieren.');
        } else {
          setBanner('switching', 'INTERNETSTÃ–RUNG â€“ Bitte in 5min erneut probierenâ€¦');
        }

        (async () => {
          const internetOK = await probeInternetOK();
          let extra = '';
          if (!internetOK) {
            extra = `<p>Hinweis: Deine Internetverbindung scheint aktuell gestÃ¶rt.</p>`;
          } else {
            const loc = await probeLocation();
            if (loc && !loc.allowed) {
              extra = `<p><strong>Zugriff nur aus Deutschland oder Spanien mÃ¶glich.</strong> Dein Standort: ${loc.city}, ${loc.country}${loc.vpn ? ' (VPN erkannt)' : ''}.</p>`;
            } else if (loc && loc.vpn) {
              extra = `<p>Hinweis: MÃ¶glicherweise nutzt du ein VPN â€“ Verbindung kÃ¶nnte eingeschrÃ¤nkt sein.</p>`;
            }
          }
          const base = isOffline
            ? `<p><b>Server offline.</b> Bitte Administrator kontaktieren.</p>`
            : `<p>Verbindeâ€¦ (${Math.floor(elapsed/1000)} s ohne Antwort)</p>`;

          const speedBtn = document.getElementById('speedtest-btn');
          if (!internetOK) {
            speedBtn.innerHTML = `Speedtest<br><small>Internet gestÃ¶rt</small>`;
          } else {
            speedBtn.innerHTML = `Speedtest<br><small>Server nicht erreichbar</small>`;
          }

          document.getElementById('status-box').innerHTML = base + extra;
        })();

        setInterval(() => {
          if (failSinceTs) {
            const elapsed = Date.now() - failSinceTs;
            if (elapsed >= OFFLINE_THRESHOLD_MS) setBanner('offline');
          }
        }, 5000);
      }
    }

    async function getStatusSafe() {
      const res = await fetchWithTimeout(`${API_BASE}/status`, {}, FETCH_TIMEOUT_MS_STATUS);
      return res.json();
    }

  async function pollForResult(btn, prevTs, pollTimer) {
  const t0 = Date.now();
  let lastSpeed = null;

  try {
    const initial = await getStatusSafe();
    lastSpeed = initial?.vpn?.last_speedtest || null;
  } catch {}

  while (Date.now() - t0 < SPEEDTEST_POLL_TIMEOUT_MS) {
    await new Promise(r => setTimeout(r, SPEEDTEST_POLL_INTERVAL_MS));
    try {
      const now = await getStatusSafe();
      const currentSpeed = now?.vpn?.last_speedtest;
      if (!currentSpeed) continue;

      const tsChanged = prevTs && currentSpeed.timestamp && currentSpeed.timestamp !== prevTs;
      const valuesChanged = lastSpeed && (
        currentSpeed.download !== lastSpeed.download ||
        currentSpeed.upload !== lastSpeed.upload ||
        currentSpeed.ping !== lastSpeed.ping
      );

      if (tsChanged || valuesChanged || (!lastSpeed && currentSpeed.download > 0)) {
        if (pollTimer) clearInterval(pollTimer);
        btn.classList.add('success');
        setBtnState(btn, 'âœ… Erfolgreich! Danke!', true);
        await loadStatus();
        return true;
      }

      lastSpeed = currentSpeed;
    } catch {}
  }

  if (pollTimer) clearInterval(pollTimer);
  btn.classList.add('error');
  setBtnState(btn, 'Fehlgeschlagen (kein Ergebnis)', true);
  return false;
}

    async function runSpeedtest() {
      const btn = document.getElementById('speedtest-btn');
      let skipReset = false;
      setBtnState(btn, 'Wird geprÃ¼ftâ€¦', true);
      btn.classList.remove('success', 'error');
      btn.classList.add('loading');
      let prevTs = null;
      let prevSpeed = { download: 0, upload: 0, ping: 0 };
      try {
        const before = await getStatusSafe();
        const speed = before?.vpn?.last_speedtest;
        if (speed) {
          prevTs = speed.timestamp || null;
          prevSpeed = { download: speed.download || 0, upload: speed.upload || 0, ping: speed.ping || 0 };
        }
      } catch {}
      let pollCount = 0;
      let pollTimer = null;
      try {
        const res = await fetchWithTimeout(`${API_BASE}/speedtest/run`, {
        method: 'POST',
        headers: { 'X-Token': SPEEDTEST_TOKEN, 'Accept': 'application/json' }
      }, FETCH_TIMEOUT_MS_SPEEDTEST);
      let data = null;
      try {
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) data = await res.json();
      } catch {}
        
      // ğŸ”´ Cooldown vom Backend
      if (data && data.cooldown) {
        btn.classList.remove('loading');
        skipReset = true;

        let remaining = data.remaining || 300;
        const updateLabel = () => {
          const m = Math.floor(remaining / 60);
          const s = remaining % 60;
          setBtnState(
            btn,
            `â±ï¸ Speedtest gesperrt (${m}:${String(s).padStart(2, '0')})`,
            true
          );
          remaining--;
          if (remaining < 0) {
            clearInterval(cdTimer);
            btn.classList.remove('error', 'loading');
            setBtnState(btn, 'â±ï¸ Speedtest (Server) starten', false);
          }
        };
        updateLabel();
        const cdTimer = setInterval(updateLabel, 1000);
        return;
      }
        
        if (data && data.success === true) {
          btn.classList.remove('loading');
          setBtnState(btn, 'âŒ› LÃ¤uftâ€¦ (~60 s)', true);
          pollTimer = setInterval(() => {
            pollCount++;
            setBtnState(btn, `âŒ› LÃ¤uftâ€¦ (~60 s) (${pollCount * 2}s)`, true);
          }, SPEEDTEST_POLL_INTERVAL_MS);
          await pollForResult(btn, prevTs, pollTimer);
          return;
        }
        if (res.ok || res.status === 202) {
          btn.classList.remove('loading');
          setBtnState(btn, 'âŒ› LÃ¤uftâ€¦ (~60 s)', true);
          pollTimer = setInterval(() => {
            pollCount++;
            setBtnState(btn, `âŒ› LÃ¤uftâ€¦ (~60 s) (${pollCount * 2}s)`, true);
          }, SPEEDTEST_POLL_INTERVAL_MS);
          await pollForResult(btn, prevTs, pollTimer);
          return;
        }
        throw new Error(`HTTP ${res.status}`);
      } catch (e) {
        if (String(e.message).toLowerCase().includes('timeout')) {
          btn.classList.remove('loading');
          setBtnState(btn, 'âŒ› LÃ¤uftâ€¦ (Timeout, prÃ¼fe Ergebnis)', true);
          pollTimer = setInterval(() => {
            pollCount++;
            setBtnState(btn, `âŒ› LÃ¤uftâ€¦ (~63 s) (${pollCount * 2}s)`, true);
          }, SPEEDTEST_POLL_INTERVAL_MS);
          await pollForResult(btn, prevTs, pollTimer);
          return;
        }
        console.error('Speedtest Fehler:', e);
        btn.classList.remove('loading');
        btn.classList.add('error');
        setBtnState(btn, 'Fehlgeschlagen', true);
            } finally {
        if (!skipReset) {
          setTimeout(() => {
            if (pollTimer) clearInterval(pollTimer);
            setBtnState(btn, 'â±ï¸ Speedtest (Server) starten', false);
            btn.classList.remove('success', 'error', 'loading');
          }, 2000);
        }
      }
    }

// === Client-Speedtest (deine Leitung â†’ Fritflix) ===
const CLIENT_TEST_FILE_URL = `${API_BASE}/client-test.bin`;
const CLIENT_TEST_FILE_SIZE_BYTES = 20 * 1024 * 1024;
const CLIENT_PING_URL = `${API_BASE}/health`;

// Optional: Ping kann offen bleiben (health ist bei dir ohne Token).
// Wenn du Ping auch "sauber" Ã¼ber apiFetch willst: unten ist eine Variante.
async function measureClientPing(repeats = 4) {
  const times = [];
  for (let i = 0; i < repeats; i++) {
    const start = performance.now();
    try {
      await fetch(CLIENT_PING_URL + '?t=' + Date.now(), { cache: 'no-store' });
      times.push(performance.now() - start);
    } catch (e) {
      console.warn('Client-Ping-Fehler:', e);
    }
  }
  if (!times.length) return null;
  return times.reduce((a, b) => a + b, 0) / times.length;
}

async function measureClientDownload() {
  const start = performance.now();

  // WICHTIG: apiFetch benutzen -> setzt X-App-Token Header
  // apiFetch erwartet bei dir einen Pfad relativ zu /api (so wie bei /latest/items)
  const res = await apiFetch(`/client-test.bin?t=${Date.now()}`, {
    method: 'GET',
    cache: 'no-store',
  }, 25000);

  if (!res.ok) {
    throw new Error('HTTP-Fehler: ' + res.status);
  }

  let bytesReceived = 0;

  // Stream lesen (keine komplette Datei im RAM nÃ¶tig)
  if (res.body && res.body.getReader) {
    const reader = res.body.getReader();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      bytesReceived += value.byteLength || value.length || 0;
    }
  } else {
    const blob = await res.blob();
    bytesReceived = blob.size || CLIENT_TEST_FILE_SIZE_BYTES;
  }

  const durationSeconds = (performance.now() - start) / 1000;
  if (durationSeconds <= 0) throw new Error('Messdauer zu kurz/ungÃ¼ltig');

  const bits = bytesReceived * 8;
  const mbitPerSecond = (bits / 1_000_000) / durationSeconds;

  return { mbitPerSecond, durationSeconds };
}

async function runClientSpeedtest() {
  const btn = document.getElementById('client-speedtest-btn');
  const out = document.getElementById('client-speedtest-result');

  btn.classList.remove('success', 'error');
  btn.classList.add('loading');
  setBtnState(btn, 'ğŸ“¶ Test lÃ¤uftâ€¦', true);
  out.textContent = 'Test lÃ¤uftâ€¦ Dies kann einige Sekunden dauern.';

  try {
    const pingMs = await measureClientPing();
    const { mbitPerSecond, durationSeconds } = await measureClientDownload();

    let html = '';

    if (pingMs != null) {
      html += `â± Ping zu Fritflix: <b>${pingMs.toFixed(0)} ms</b><br>`;
    } else {
      html += `â± Ping zu Fritflix: <b>konnte nicht gemessen werden</b><br>`;
    }

    html += `ğŸ“¥ Download von Fritflix: <b>${mbitPerSecond.toFixed(1)} Mbit/s</b><br>`;
    html += `<small>(Messdauer: ${durationSeconds.toFixed(1)} s, DateigrÃ¶ÃŸe ca. ${(CLIENT_TEST_FILE_SIZE_BYTES/1024/1024).toFixed(0)} MB)</small><br><br>`;

    if (mbitPerSecond >= 22) {
      html += 'âœ… Deine Verbindung zu Fritflix ist sehr gut. HD und 4K sollten in der Regel flÃ¼ssig laufen.';
    } else if (mbitPerSecond >= 15) {
      html += 'ğŸŸ¢ Deine Verbindung ist gut. HD sollte funktionieren, 4K kann manchmal ruckeln.';
    } else if (mbitPerSecond >= 5) {
      html += 'ğŸŸ¡ Deine Verbindung ist okay. HD sollte meist funktionieren. Stelle die Bitrate auf ca. 5!';
    } else if (mbitPerSecond >= 2) {
      html += 'ğŸŸ  Deine Verbindung ist schwach. Stelle deine Bitrate auf ca. 1-2!.';
    } else {
      html += 'ğŸ”´ Deine Verbindung zu Fritflix ist sehr schwach. Streamen kaum mÃ¶glich. Das liegt sehr wahrscheinlich an deiner Leitung.';
    }

    out.innerHTML = html;
    btn.classList.remove('loading');
    btn.classList.add('success');
    setBtnState(btn, 'ğŸ“¶ Eigener Speedtest erneut starten', false);
  } catch (e) {
    console.error('Client-Speedtest Fehler:', e);
    out.innerHTML = 'âš ï¸ Fehler beim Speedtest: ' + (e.message || e);
    btn.classList.remove('loading');
    btn.classList.add('error');
    setBtnState(btn, 'Fehler â€“ erneut versuchen', false);
  }
}
    
    function setBtnState(btn, label, disabled) {
      btn.innerHTML = label;
      btn.disabled = !!disabled;
    }

    async function sendViaEmailJS(text) {
      return emailjs.send('service_i3ceboq', 'template_3iie047', {
        feedback: text,
        timestamp: new Date().toLocaleString('de-DE', { timeZone: 'Europe/Berlin' })
      });
    }

    async function sendDirect(btn, msg) {
      const orig = btn.getAttribute('data-orig') || btn.innerHTML;
      setBtnState(btn, 'Sendeâ€¦', true);
      try {
        await sendViaEmailJS(msg);
        setBtnState(btn, 'âœ… Danke fÃ¼r dein Feedback!', true);
      } catch (e) {
        setBtnState(btn, 'âœ– Fehler â€“ erneut versuchen?', false);
        return;
      }
      setTimeout(() => {
        btn.innerHTML = orig;
        btn.disabled = false;
      }, 1800);
    }

    function openModal(msg, req = false) {
      currentMsg = msg;
      requireText = req;
      document.getElementById('modal-title').textContent = msg;
      document.getElementById('extra-text').value = '';
      document.getElementById('no-text-btn').style.display = req ? 'none' : 'block';
      document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function sendWithText(btnEl) {
      const txt = document.getElementById('extra-text').value.trim();
      if (requireText && !txt) {
        alert('Text erforderlich!');
        return;
      }
      const full = currentMsg + (txt ? ' â€“ ' + txt : '');
      const orig = btnEl.innerHTML;
      setBtnState(btnEl, 'Sendeâ€¦', true);
      try {
        await sendViaEmailJS(full);
        setBtnState(btnEl, 'Danke fÃ¼r dein Feedback!', true);
        setTimeout(() => {
          closeModal();
          btnEl.innerHTML = orig;
          btnEl.disabled = false;
        }, 900);
      } catch (e) {
        setBtnState(btnEl, 'Fehler â€“ erneut?', false);
      }
    }

    async function sendWithoutText(btnEl) {
      const orig = btnEl.innerHTML;
      setBtnState(btnEl, 'Sendeâ€¦', true);
      try {
        await sendViaEmailJS(currentMsg);
        setBtnState(btnEl, 'Danke fÃ¼r dein Feedback!', true);
        setTimeout(() => {
          closeModal();
          btnEl.innerHTML = orig;
          btnEl.disabled = false;
        }, 900);
      } catch (e) {
        setBtnState(btnEl, 'Fehler â€“ erneut?', false);
      }
    }

    // FAQ Live-Suche
    function filterFAQ() {
      const query = document.getElementById('faq-search').value.toLowerCase();
      const items = document.querySelectorAll('.faq-item');
      items.forEach(item => {
        const question = item.querySelector('summary').textContent.toLowerCase();
        const answer = item.querySelector('.faq-answer').textContent.toLowerCase();
        const visible = question.includes(query) || answer.includes(query);
        item.style.display = visible ? '' : 'none';
      });
    }

    // Init
    loadStatus();
    setInterval(loadStatus, 20000);

 // Slider-Logik
let sliderPos = 0;

async function loadLatestItems() {
  try {
    const res = await apiFetch(`/latest/items?limit=20`, {}, FETCH_TIMEOUT_MS);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const container = document.getElementById('slider-container');
    container.innerHTML = '';

    if (!data.items?.length) {
      container.innerHTML = '<p style="opacity:0.7; text-align:center; padding:1em;">Keine neuen Titel</p>';
      return;
    }

container.onclick = (e) => {
  const el = e.target.closest('.slider-item[data-item]');
  if (!el) return;
  const raw = decodeURIComponent(el.getAttribute('data-item'));
  openDetail(JSON.parse(raw));
};

data.items.forEach(item => {
  const audioHtml = (item.audio_tracks || []).map(track => {
    const flag = getFlag(track.language || 'unbekannt');
    let type = (track.type || 'â€“')
      .replace(/Dolby Digital Plus/gi, 'DD+')
      .replace(/Dolby Digital/gi, 'DD')
      .replace(/Dolby Atmos/gi, 'Atmos')
      .replace(/\s*5\.1\s*/g, ' 5.1')
      .replace(/Stereo/gi, '2.0');
    return `<span>${flag} ${type.trim()}</span>`;
  }).join('<br>') || 'â€“';

let seasonInfo = '';
const hasJFSeasons = item.type === 'Series' && item.season_count_source === 'jellyfin';

if (hasJFSeasons) {
  const sc = Number(item.season_count);
  const hasSpecials = !!item.has_specials;

  if (Number.isFinite(sc) && sc > 0) {
    seasonInfo = `${sc} Staffel${sc === 1 ? '' : 'n'}`;
    if (hasSpecials) seasonInfo += ' + Specials';
  } else if (hasSpecials) {
    // falls mal nur Specials existieren
    seasonInfo = 'Specials';
  }

  // Neueste Episode nur anzeigen, wenn vorhanden
  if (item.latest_episode?.season && item.latest_episode?.episode) {
    seasonInfo += `${seasonInfo ? ' â€¢ ' : ''}S${item.latest_episode.season} E${item.latest_episode.episode}`;
  }
}
  
const genresShort = (item.genres || []).filter(Boolean).slice(0, 2);
const genresLine = genresShort.length ? `ğŸ­ ${genresShort.join(' â€¢ ')}` : '';
  
  const html = `
    <div class="slider-item" data-item="${encodeURIComponent(JSON.stringify(item))}">
      <img src="${item.cover_url}" alt="${item.name}" loading="lazy"
           onerror="this.src='https://via.placeholder.com/110x165?text=?';">
      <h4>${item.name} ${item.year ? `(${item.year})` : ''}</h4>
      <p>QualitÃ¤t: ${item.quality || 'â€“'}</p>
      <p>Ton: ${audioHtml}</p>
      ${genresLine ? `<p style="font-size:0.68em; color:#aaa; margin:2px 0 0;">${genresLine}</p>` : ''}
      ${seasonInfo ? `<p class="season-info">${seasonInfo}</p>` : ''}

    </div>
  `;
  container.innerHTML += html;
});
    
  } catch (e) {
    console.error('Latest Items Fehler:', e);
    document.getElementById('slider-container').innerHTML = 
      '<p style="color:#ff5555; text-align:center; padding:1em;">Fehler beim Laden</p>';
  }
}

function getFlag(lang) {
  const flags = {
    // Deutsch & Varianten
    'de': 'ğŸ‡©ğŸ‡ª', 'ger': 'ğŸ‡©ğŸ‡ª', 'deu': 'ğŸ‡©ğŸ‡ª',

    // Englisch
    'en': 'ğŸ‡ºğŸ‡¸', 'eng': 'ğŸ‡ºğŸ‡¸', 'gb': 'ğŸ‡¬ğŸ‡§', 'us': 'ğŸ‡ºğŸ‡¸',

    // Spanisch
    'es': 'ğŸ‡ªğŸ‡¸', 'spa': 'ğŸ‡ªğŸ‡¸',

    // FranzÃ¶sisch
    'fr': 'ğŸ‡«ğŸ‡·', 'fra': 'ğŸ‡«ğŸ‡·', 'fre': 'ğŸ‡«ğŸ‡·',

    // Italienisch
    'it': 'ğŸ‡®ğŸ‡¹', 'ita': 'ğŸ‡®ğŸ‡¹',

    // NiederlÃ¤ndisch (neu)
    'nl': 'ğŸ‡³ğŸ‡±', 'nld': 'ğŸ‡³ğŸ‡±', 'dut': 'ğŸ‡³ğŸ‡±',

    // DÃ¤nisch (neu)
    'da': 'ğŸ‡©ğŸ‡°', 'dan': 'ğŸ‡©ğŸ‡°',

    // Schwedisch
    'sv': 'ğŸ‡¸ğŸ‡ª', 'swe': 'ğŸ‡¸ğŸ‡ª',

    // Norwegisch
    'no': 'ğŸ‡³ğŸ‡´', 'nor': 'ğŸ‡³ğŸ‡´',

    // Finnisch
    'fi': 'ğŸ‡«ğŸ‡®', 'fin': 'ğŸ‡«ğŸ‡®',

    // Polnisch
    'pl': 'ğŸ‡µğŸ‡±', 'pol': 'ğŸ‡µğŸ‡±',

    // Portugiesisch
    'pt': 'ğŸ‡µğŸ‡¹', 'por': 'ğŸ‡µğŸ‡¹',

    // Japanisch
    'ja': 'ğŸ‡¯ğŸ‡µ', 'jpn': 'ğŸ‡¯ğŸ‡µ',

    // Koreanisch
    'ko': 'ğŸ‡°ğŸ‡·', 'kor': 'ğŸ‡°ğŸ‡·',

    // Chinesisch
    'zh': 'ğŸ‡¨ğŸ‡³', 'chi': 'ğŸ‡¨ğŸ‡³', 'zho': 'ğŸ‡¨ğŸ‡³',

    // Russisch
    'ru': 'ğŸ‡·ğŸ‡º', 'rus': 'ğŸ‡·ğŸ‡º',

    // Fallbacks
    'unbekannt': 'â“',
    'â€“': 'â“',
    '': 'â“'
  };

  // Sprache normalisieren (z. B. "de-DE" â†’ "de")
  const normalized = (lang || '').toLowerCase().split('-')[0].trim();

  return flags[normalized] || 'ğŸŒ';
}

// ===============================
// Helpers: Dedup + Format
// ===============================
function uniqTracks(tracks, keyFn) {
  const seen = new Set();
  const out = [];
  for (const t of (tracks || [])) {
    const k = keyFn(t);
    if (seen.has(k)) continue;
    seen.add(k);
    out.push(t);
  }
  return out;
}

function safeNum(v) {
  const n = Number(v);
  return (v != null && !Number.isNaN(n)) ? n : null;
}

// Audio: dedup + eine Zeile
function formatAudioLine(audioTracks) {
  const aud = uniqTracks(audioTracks, t => `${t.language || ''}|${t.type || ''}`);
  if (!aud.length) return '';

  return `ğŸ”Š ${aud.map(t => `${getFlag(t.language)} ${t.type || 'â€“'}`.trim()).join(' â€¢ ')}`;
}

// Subs: dedup + FULL wichtig, FORCED klein
function formatSubtitleLines(subTracks) {
  const subs = uniqTracks(subTracks, s => `${s.language || ''}|${s.kind || 'full'}|${s.format || ''}`);
  if (!subs.length) return { full: '', forcedHtml: '' };

  const subsFull = subs.filter(s => (s.kind || 'full') === 'full');
  const subsForced = subs.filter(s => s.kind === 'forced');

  const full = subsFull.length
    ? `ğŸ’¬ ${subsFull
        .map(s => `${getFlag(s.language)} ${(s.format || '').trim()}`.trim())
        .join(' â€¢ ')}`
    : '';

  const forcedHtml = subsForced.length
    ? `<span class="detail-subs-forced">(forced: ${subsForced.map(s => getFlag(s.language)).join(' ')})</span>`
    : '';

  return { full, forcedHtml };
}

// ===============================
// Modal: Detail
// ===============================
function openDetail(item) {
  const modal = document.getElementById('detailModal');
  const content = document.getElementById('detailContent');

  // Trailer
  const trailerBtn = item.trailer
    ? `<a href="${item.trailer}" target="_blank" class="detail-btn trailer">ğŸ¬ Trailer ansehen</a>`
    : '';

  const genresHtml = (item.genres && item.genres.length)
  ? `<p><strong>Genres:</strong> ${item.genres.join(' â€¢ ')}</p>`
  : '';

  // === Kombi-Rating: Jellyfin CommunityRating -> "IMDb" (Link nur wenn imdb_id), sonst TMDB ===
  const jellyRating = safeNum(item.community_rating);
  const tmdbRating = safeNum(item.tmdb_rating);

  let ratingHtml = '';
  if (jellyRating != null || tmdbRating != null) {
    let label = '';
    let score = null;
    let href = null;

    if (jellyRating != null) {
      score = jellyRating;
      label = 'IMDb';
      if (item.imdb_id) href = `https://www.imdb.com/title/${item.imdb_id}`;
    } else if (tmdbRating != null) {
      score = tmdbRating;
      label = 'TMDB';
      if (item.tmdb_id) {
        const kind = (item.type === 'Series') ? 'tv' : 'movie';
        href = `https://www.themoviedb.org/${kind}/${item.tmdb_id}`;
      }
    }

    if (score != null) {
      const text = `â­ ${score.toFixed(1)}/10 ${label}`;
      ratingHtml = href
        ? `<a href="${href}" target="_blank" class="detail-btn imdb">${text}</a>`
        : `<div class="detail-btn imdb static">${text}</div>`;
    }
  }

  // Rotten (Jellyfin CriticRating 0â€“100)
  let rottenHtml = '';
  const rottenScore = safeNum(item.rotten_rating);
  if (rottenScore != null) {
    const score = Math.round(rottenScore);
    const rtClass = score >= 60 ? 'fresh' : 'rotten';
    rottenHtml = `<div class="detail-btn rt ${rtClass} static">ğŸ… Rotten ${score}%</div>`;
  }

  // Serieninfo
let seasonInfo = '';
if (item.type === 'Series') {
  const sc = Number(item.season_count);
  const hasSpecials = !!item.has_specials;

  // Optional: spÃ¤ter aus API lieferbar, z.B. item.special_movies_count oder item.has_movies
  const hasMovies = !!item.has_movies; // bleibt erstmal false/undefined, bis du es serverseitig ergÃ¤nzt

  if (item.season_count_source === 'jellyfin' && Number.isFinite(sc) && sc > 0) {
    let label = `${sc} Staffel${sc === 1 ? '' : 'n'}`;

    if (hasSpecials) label += ' inkl. Specials und/oder Filme';

    seasonInfo = `<p><strong>Staffeln:</strong> ${label}</p>`;
  } else if (hasSpecials) {
    // falls nur Specials existieren
    seasonInfo = `<p><strong>Specials:</strong> vorhanden</p>`;
  } else {
    seasonInfo = '';
  }

  if (item.latest_episode) {
    const ep = item.latest_episode;
    seasonInfo += `<p><strong>Neueste:</strong> S${ep.season || '?'} E${ep.episode || '?'} â€“ ${ep.name || 'Episode'}</p>`;
  }
}

  // Audio + Subs (DEDUP + kompakt)
  const audioLine = formatAudioLine(item.audio_tracks);

  const { full: fullSubsLine, forcedHtml: forcedSubsLine } =
    formatSubtitleLines(item.subtitle_tracks);

  content.innerHTML = `
    <div class="detail-layout">
      <div style="flex:1; min-width:240px; text-align:center;">
        <img src="${item.poster_large || item.cover_url}" class="detail-poster" loading="lazy"
             onerror="this.src='https://via.placeholder.com/300x450?text=Poster';">
      </div>

      <div style="flex:2; min-width:300px;">
        <h2 class="detail-header">${item.name} ${item.year ? `(${item.year})` : ''}</h2>

        <div class="detail-meta">
          ${item.type === 'Movie' ? 'Film' : 'Serie'} â€¢ ${item.quality || 'â€“'}
        </div>

        ${audioLine ? `<div class="detail-audio">${audioLine}</div>` : ''}
        ${(fullSubsLine || forcedSubsLine)
          ? `<div class="detail-subs">${fullSubsLine} ${forcedSubsLine}</div>`
          : ''}

        <p class="detail-overview">
          ${item.overview || '<i>Keine Beschreibung verfÃ¼gbar</i>'}
        </p>

        ${item.runtime ? `<p><strong>Laufzeit:</strong> ${item.runtime} Min</p>` : ''}
        ${genresHtml}

        ${seasonInfo}

        <div class="detail-actions">
          ${trailerBtn}
          ${ratingHtml}
          ${rottenHtml}
        </div>
      </div>
    </div>
  `;

  modal.style.display = 'flex';
}

// Pfeile + Wischen (wie vorher)
const sliderContainer = document.getElementById('slider-container');

// Init
loadLatestItems();
setInterval(loadLatestItems, 300000);  // Slider alle 5 Min
    
  </script>

  <div id="update-banner" style="
  display:none;
  position:fixed;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  background:#222;
  color:#fff;
  border:1px solid #444;
  border-radius:999px;
  padding:0.5em 1em;
  font-size:0.9em;
  box-shadow:0 2px 8px rgba(0,0,0,0.5);
  z-index:9999;
">
  Neue Version von Fritflix Feedback verfÃ¼gbar.
  <button id="update-reload-btn" style="
    margin-left:0.7em;
    padding:0.3em 0.8em;
    border:none;
    border-radius:999px;
    background:#e50914;
    color:#fff;
    font-weight:600;
    cursor:pointer;
  ">
    Aktualisieren
  </button>

</div>
<div id="detailModal">
  <div class="detail-content">
    <button class="close-detail" onclick="document.getElementById('detailModal').style.display='none'">Ã—</button>
    <div id="detailContent"></div>
  </div>
</div>
</body>
</html>
